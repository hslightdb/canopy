<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Canopy Utility Functions &mdash; Canopy 10.2 documentation</title>
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/citus.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/flexboxgrid.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/pygments.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Canopy Tables and Views" href="api_metadata.html" />
    <link rel="prev" title="Canopy API" href="api.html" />
  
  <script>
    /*
      Global variable shared with cookie consent dialog code.
      This is to use its value uniformly throughout the page.
    */
    window.g_cookieConsentId = 'CitusCookieConsentCorner';

    if (document.cookie.indexOf(window.g_cookieConsentId) == -1) {
      window.YETT_BLACKLIST = [
        /munchkin\.marketo\.net/,
        /sjs\.bizographics\.com/,
        /doubleclick\.net/,
        /cdn\.heapanalytics\.com/,
      ];
    } else {
      console.log("Cookies already accepted");
      window.YETT_BLACKLIST = [ ];
    }
  </script>
  <script src='https://unpkg.com/yett'></script>

   

  
  <script>
    // Read The Docs is responsible for loading GA by
    // injecting a script into all pages. The function
    // below assumes that this has happened.
    window.trackOutboundLink = function(url) {
      if (typeof(ga) == 'function') {
        ga('send', 'event', 'outbound', 'click', url, {
          'transport': 'beacon',
          'hitCallback': function(){document.location = url;}
        });
        // cancel navigation due to click, allow the hitCallback to
        // navigate to the next page after ga() has registered event
        return false;
      } else {
        console.log("trackOutboundLink: Unable to access ga()");
        // ga() was a no-go so allow navigation to proceed
        return true;
      }
    };
  </script>

  
  <meta name="google-site-verification" content="v8MtCUC2nV2dO-4CSGb5flD1MyPKJvw7wBDOYRwBadw" />

  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">

  
  

  
  <meta property="og:image" content="https://docs.citusdata.com/en/stable/_images/citus-docs-og-logo.png" />
  <meta property="og:title" content="Canopy Utility Functions - Canopy 10.2 documentation" />
  <meta property="og:description" content="Docs for the Citus extension to Postgres. Citus distributes your data &amp; queries across multiple nodes in a cluster, so your database can scale and your queries are fast." />

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
  <a class="skiplink" href="#maincontent">Skip to main content ></a>
  <a href="https://citusdata.com" class="homepage">
    <img src=../_images/logo.png class="logo" alt="Citus Data logo" />
  </a>

  
            <a href="../index.html" class="icon icon-home"> Canopy
          </a>
              <div class="version">
                10.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" id="main-search" autocomplete="off" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        </div>
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Main">
              <p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../get_started/what_is_citus.html">What is Canopy?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../get_started/what_is_citus.html#how-far-can-canopy-scale">How Far Can Canopy Scale?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/what_is_citus.html#when-to-use-canopy">When to Use Canopy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../get_started/what_is_citus.html#multi-tenant-database">Multi-Tenant Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get_started/what_is_citus.html#real-time-analytics">Real-Time Analytics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get_started/what_is_citus.html#considerations-for-use">Considerations for Use</a></li>
<li class="toctree-l2"><a class="reference internal" href="../get_started/what_is_citus.html#when-canopy-is-inappropriate">When Canopy is Inappropriate</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/tutorials.html">Quick Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../get_started/tutorial_multi_tenant.html">Multi-tenant Applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../get_started/tutorial_multi_tenant.html#data-model-and-sample-data">Data model and sample data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/tutorial_multi_tenant.html#creating-tables">Creating tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/tutorial_multi_tenant.html#distributing-tables-and-loading-data">Distributing tables and loading data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/tutorial_multi_tenant.html#running-queries">Running queries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../get_started/tutorial_realtime_analytics.html">Real-time Analytics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../get_started/tutorial_realtime_analytics.html#data-model-and-sample-data">Data model and sample data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/tutorial_realtime_analytics.html#creating-tables">Creating tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/tutorial_realtime_analytics.html#distributing-tables-and-loading-data">Distributing tables and loading data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/tutorial_realtime_analytics.html#running-queries">Running queries</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Install</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/single_node.html">Single-Node Canopy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation/single_node_rhel.html">CentOS or Red Hat</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation/multi_node.html">Multi-Node Canopy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation/multi_node_rhel.html">CentOS or Red Hat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation/multi_node_rhel.html#steps-to-be-executed-on-all-nodes">Steps to be executed on all nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation/multi_node_rhel.html#steps-to-be-executed-on-the-coordinator-node">Steps to be executed on the coordinator node</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use-Case Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../use_cases/multi_tenant.html">Multi-tenant Applications</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#let-s-make-an-app-ad-analytics">Let’s Make an App – Ad Analytics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#scaling-the-relational-data-model">Scaling the Relational Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#preparing-tables-and-ingesting-data">Preparing Tables and Ingesting Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../use_cases/multi_tenant.html#try-it-yourself">Try it Yourself</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#integrating-applications">Integrating Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#sharing-data-between-tenants">Sharing Data Between Tenants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#online-changes-to-the-schema">Online Changes to the Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#when-data-differs-across-tenants">When Data Differs Across Tenants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#scaling-hardware-resources">Scaling Hardware Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/multi_tenant.html#where-to-go-from-here">Where to Go From Here</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../use_cases/realtime_analytics.html">Real-Time Dashboards</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/realtime_analytics.html#data-model">Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/realtime_analytics.html#rollups">Rollups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/realtime_analytics.html#expiring-old-data">Expiring Old Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/realtime_analytics.html#approximate-distinct-counts">Approximate Distinct Counts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/realtime_analytics.html#unstructured-data-with-jsonb">Unstructured Data with JSONB</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../use_cases/timeseries.html">Timeseries Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/timeseries.html#scaling-timeseries-data-on-canopy">Scaling Timeseries Data on Canopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/timeseries.html#automating-partition-creation">Automating Partition Creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/timeseries.html#archiving-with-columnar-storage">Archiving with Columnar Storage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../use_cases/timeseries.html#archiving-a-row-partition-to-columnar-storage">Archiving a Row Partition to Columnar Storage</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architecture</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../get_started/concepts.html">Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../get_started/concepts.html#nodes">Nodes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../get_started/concepts.html#coordinator-and-workers">Coordinator and Workers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../get_started/concepts.html#distributed-data">Distributed Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../get_started/concepts.html#table-types">Table Types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../get_started/concepts.html#type-1-distributed-tables">Type 1: Distributed Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../get_started/concepts.html#type-2-reference-tables">Type 2: Reference Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../get_started/concepts.html#type-3-local-tables">Type 3: Local Tables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/concepts.html#shards">Shards</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../get_started/concepts.html#shard-placements">Shard Placements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/concepts.html#co-location">Co-Location</a></li>
<li class="toctree-l3"><a class="reference internal" href="../get_started/concepts.html#parallelism">Parallelism</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../get_started/concepts.html#query-execution">Query Execution</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Develop</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="app_type.html">Determining Application Type</a><ul>
<li class="toctree-l2"><a class="reference internal" href="app_type.html#at-a-glance">At a Glance</a></li>
<li class="toctree-l2"><a class="reference internal" href="app_type.html#examples-and-characteristics">Examples and Characteristics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../sharding/data_modeling.html">Choosing Distribution Column</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../sharding/data_modeling.html#multi-tenant-apps">Multi-Tenant Apps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sharding/data_modeling.html#real-time-apps">Real-Time Apps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#id1">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sharding/data_modeling.html#timeseries-data">Timeseries Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#id2">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sharding/data_modeling.html#table-co-location">Table Co-Location</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#data-co-location-in-canopy-for-hash-distributed-tables">Data co-location in Canopy for hash-distributed tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#a-practical-example-of-co-location">A practical example of co-location</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#using-regular-lightdb-tables">Using Regular LightDB Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#distributing-tables-by-id">Distributing tables by ID</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#distributing-tables-by-tenant">Distributing tables by tenant</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#co-location-means-better-feature-support">Co-location means better feature support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sharding/data_modeling.html#query-performance">Query Performance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">Migrating an Existing App</a><ul>
<li class="toctree-l2"><a class="reference internal" href="migration_mt_schema.html">Identify Distribution Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="migration_mt_schema.html#pick-distribution-key">Pick distribution key</a></li>
<li class="toctree-l3"><a class="reference internal" href="migration_mt_schema.html#identify-types-of-tables">Identify types of tables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="migration_mt_schema.html#prepare-source-tables-for-migration">Prepare Source Tables for Migration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="migration_mt_schema.html#add-distribution-keys">Add distribution keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="migration_mt_schema.html#backfill-newly-created-columns">Backfill newly created columns</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="migration_mt_query.html">Prepare Application for Canopy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="migration_mt_query.html#set-up-development-canopy-cluster">Set up Development Canopy Cluster</a><ul>
<li class="toctree-l4"><a class="reference internal" href="migration_mt_query.html#include-distribution-column-in-keys">Include distribution column in keys</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="migration_mt_query.html#add-distribution-key-to-queries">Add distribution key to queries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="migration_mt_ror.html">Ruby on Rails</a></li>
<li class="toctree-l4"><a class="reference internal" href="migration_mt_django.html">Django</a></li>
<li class="toctree-l4"><a class="reference internal" href="migration_mt_asp.html">ASP.NET</a></li>
<li class="toctree-l4"><a class="reference internal" href="migration_mt_query.html#other-sql-principles">Other (SQL Principles)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="migration_mt_query.html#enable-secure-connections">Enable Secure Connections</a></li>
<li class="toctree-l3"><a class="reference internal" href="migration_mt_query.html#check-for-cross-node-traffic">Check for cross-node traffic</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="migration_data.html">Migrate Production Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="migration_data_small.html">Small Database Migration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">SQL Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="reference_ddl.html">Creating and Modifying Distributed Tables (DDL)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference_ddl.html#creating-and-distributing-tables">Creating And Distributing Tables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference_ddl.html#reference-tables">Reference Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_ddl.html#distributing-coordinator-data">Distributing Coordinator Data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="reference_ddl.html#co-locating-tables">Co-Locating Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_ddl.html#dropping-tables">Dropping Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_ddl.html#modifying-tables">Modifying Tables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference_ddl.html#adding-modifying-columns">Adding/Modifying Columns</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_ddl.html#adding-removing-constraints">Adding/Removing Constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_ddl.html#using-not-valid-constraints">Using NOT VALID Constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_ddl.html#adding-removing-indices">Adding/Removing Indices</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_ddl.html#manual-modification">Manual Modification</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference_dml.html">Ingesting, Modifying Data (DML)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference_dml.html#inserting-data">Inserting Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference_dml.html#from-select-clause-distributed-rollups">“From Select” Clause (Distributed Rollups)</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_dml.html#copy-command-bulk-load">COPY Command (Bulk load)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference_dml.html#caching-aggregations-with-rollups">Caching Aggregations with Rollups</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference_dml.html#updates-and-deletion">Updates and Deletion</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_dml.html#maximizing-write-performance">Maximizing Write Performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference_sql.html">Querying Distributed Tables (SQL)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference_sql.html#aggregate-functions">Aggregate Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference_sql.html#count-distinct-aggregates">Count (Distinct) Aggregates</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_sql.html#estimating-top-n-items">Estimating Top N Items</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_sql.html#percentile-calculations">Percentile Calculations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="reference_sql.html#limit-pushdown">Limit Pushdown</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_sql.html#views-on-distributed-tables">Views on Distributed Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_sql.html#joins">Joins</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference_sql.html#co-located-joins">Co-located joins</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_sql.html#reference-table-joins">Reference table joins</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_sql.html#repartition-joins">Repartition joins</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference_processing.html">Query Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference_processing.html#distributed-query-planner">Distributed Query Planner</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_processing.html#distributed-query-executor">Distributed Query Executor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference_processing.html#subquery-cte-push-pull-execution">Subquery/CTE Push-Pull Execution</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="reference_processing.html#lightdb-planner-and-executor">LightDB planner and executor</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference_propagation.html">Manual Query Propagation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference_propagation.html#running-on-all-workers">Running on all Workers</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_propagation.html#running-on-all-shards">Running on all Shards</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_propagation.html#running-on-all-placements">Running on all Placements</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference_propagation.html#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference_workarounds.html">SQL Support and Workarounds</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference_workarounds.html#workarounds">Workarounds</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference_workarounds.html#work-around-limitations-using-ctes">Work around limitations using CTEs</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference_workarounds.html#temp-tables-the-workaround-of-last-resort">Temp Tables: the Workaround of Last Resort</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="api.html">Canopy API</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Canopy Utility Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#table-and-shard-ddl">Table and Shard DDL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-distributed-table">create_distributed_table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#truncate-local-data-after-distributing-table">truncate_local_data_after_distributing_table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#undistribute-table">undistribute_table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#alter-distributed-table">alter_distributed_table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#alter-table-set-access-method">alter_table_set_access_method</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remove-local-tables-from-metadata">remove_local_tables_from_metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-reference-table">create_reference_table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mark-tables-colocated">mark_tables_colocated</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-distributed-table-colocation">update_distributed_table_colocation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-distributed-function">create_distributed_function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#master-create-empty-shard">master_create_empty_shard</a></li>
<li class="toctree-l4"><a class="reference internal" href="#alter-columnar-table-set">alter_columnar_table_set</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-time-partitions">create_time_partitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#drop-old-time-partitions">drop_old_time_partitions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#alter-old-partitions-set-access-method">alter_old_partitions_set_access_method</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#table-and-shard-dml">Table and Shard DML</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#master-append-table-to-shard">master_append_table_to_shard</a></li>
<li class="toctree-l4"><a class="reference internal" href="#master-apply-delete-command">master_apply_delete_command</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#metadata-configuration-information">Metadata / Configuration Information</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#canopy-add-node">canopy_add_node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-update-node">canopy_update_node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-set-node-property">canopy_set_node_property</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-add-inactive-node">canopy_add_inactive_node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-activate-node">canopy_activate_node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-disable-node">canopy_disable_node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-add-secondary-node">canopy_add_secondary_node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-remove-node">canopy_remove_node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-get-active-worker-nodes">canopy_get_active_worker_nodes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-set-coordinator-host">canopy_set_coordinator_host</a></li>
<li class="toctree-l4"><a class="reference internal" href="#master-get-table-metadata">master_get_table_metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-shard-id-for-distribution-column">get_shard_id_for_distribution_column</a></li>
<li class="toctree-l4"><a class="reference internal" href="#column-to-column-name">column_to_column_name</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-relation-size">canopy_relation_size</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-table-size">canopy_table_size</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-total-relation-size">canopy_total_relation_size</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cluster-management-and-repair-functions">Cluster Management And Repair Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#canopy-copy-shard-placement">canopy_copy_shard_placement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-move-shard-placement">canopy_move_shard_placement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rebalance-table-shards">rebalance_table_shards</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-rebalance-table-shards-plan">get_rebalance_table_shards_plan</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-rebalance-progress">get_rebalance_progress</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-add-rebalance-strategy">canopy_add_rebalance_strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-set-default-rebalance-strategy">canopy_set_default_rebalance_strategy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-remote-connection-stats">canopy_remote_connection_stats</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-drain-node">canopy_drain_node</a></li>
<li class="toctree-l4"><a class="reference internal" href="#replicate-table-shards">replicate_table_shards</a></li>
<li class="toctree-l4"><a class="reference internal" href="#canopy-create-restore-point">canopy_create_restore_point</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api_metadata.html">Canopy Tables and Views</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api_metadata.html#coordinator-metadata">Coordinator Metadata</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#partition-table">Partition table</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#shard-table">Shard table</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#shard-information-view">Shard information view</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#shard-placement-table">Shard placement table</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#worker-node-table">Worker node table</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#distributed-object-table">Distributed object table</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#canopy-tables-view">Canopy tables view</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#time-partitions-view">Time partitions view</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#co-location-group-table">Co-location group table</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#rebalancer-strategy-table">Rebalancer strategy table</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_metadata.html#distributed-query-activity">Distributed Query Activity</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api_guc.html">Configuration Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api_guc.html#general-configuration">General configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-max-worker-nodes-tracked-integer">canopy.max_worker_nodes_tracked (integer)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-use-secondary-nodes-enum">canopy.use_secondary_nodes (enum)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-cluster-name-text">canopy.cluster_name (text)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-enable-version-checks-boolean">canopy.enable_version_checks (boolean)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-log-distributed-deadlock-detection-boolean">canopy.log_distributed_deadlock_detection (boolean)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-distributed-deadlock-detection-factor-floating-point">canopy.distributed_deadlock_detection_factor (floating point)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-node-connection-timeout-integer">canopy.node_connection_timeout (integer)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-node-conninfo-text">canopy.node_conninfo (text)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-local-hostname-text">canopy.local_hostname (text)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api_guc.html#data-loading">Data Loading</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-multi-shard-commit-protocol-enum">canopy.multi_shard_commit_protocol (enum)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-shard-replication-factor-integer">canopy.shard_replication_factor (integer)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-shard-count-integer">canopy.shard_count (integer)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-shard-max-size-integer">canopy.shard_max_size (integer)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-replicate-reference-tables-on-activate-boolean">canopy.replicate_reference_tables_on_activate (boolean)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api_guc.html#planner-configuration">Planner Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-local-table-join-policy-enum">canopy.local_table_join_policy (enum)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-limit-clause-row-fetch-count-integer">canopy.limit_clause_row_fetch_count (integer)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-count-distinct-error-rate-floating-point">canopy.count_distinct_error_rate (floating point)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-task-assignment-policy-enum">canopy.task_assignment_policy (enum)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api_guc.html#intermediate-data-transfer">Intermediate Data Transfer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-binary-worker-copy-format-boolean">canopy.binary_worker_copy_format (boolean)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-max-intermediate-result-size-integer">canopy.max_intermediate_result_size (integer)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api_guc.html#ddl">DDL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-enable-ddl-propagation-boolean">canopy.enable_ddl_propagation (boolean)</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#canopy-enable-local-reference-table-foreign-keys-boolean">canopy.enable_local_reference_table_foreign_keys (boolean)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="api_guc.html#executor-configuration">Executor Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#general">General</a></li>
<li class="toctree-l4"><a class="reference internal" href="api_guc.html#explain-output">Explain output</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="append.html">Append Distribution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="append.html#creating-and-distributing-tables">Creating and Distributing Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="append.html#expiring-data">Expiring Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="append.html#deleting-data">Deleting Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="append.html#dropping-tables">Dropping Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="append.html#data-loading">Data Loading</a><ul>
<li class="toctree-l4"><a class="reference internal" href="append.html#bulk-load-using-copy">Bulk load using \copy</a></li>
<li class="toctree-l4"><a class="reference internal" href="append.html#incremental-loads-by-appending-to-existing-shards">Incremental loads by appending to existing shards</a></li>
<li class="toctree-l4"><a class="reference internal" href="append.html#increasing-data-loading-performance">Increasing data loading performance</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="append.html#scaling-data-ingestion">Scaling Data Ingestion</a><ul>
<li class="toctree-l4"><a class="reference internal" href="append.html#coordinator-node-bulk-ingestion-100k-s-200k-s">Coordinator Node Bulk Ingestion (100k/s-200k/s)</a></li>
<li class="toctree-l4"><a class="reference internal" href="append.html#worker-node-bulk-ingestion-100k-s-1m-s">Worker Node Bulk Ingestion (100k/s-1M/s)</a></li>
<li class="toctree-l4"><a class="reference internal" href="append.html#pre-processing-data-in-canopy">Pre-processing Data in Canopy</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="integrations.html">External Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="integrations.html#ingesting-data-from-kafka">Ingesting Data from Kafka</a><ul>
<li class="toctree-l3"><a class="reference internal" href="integrations.html#caveats">Caveats</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="integrations.html#ingesting-data-from-spark">Ingesting Data from Spark</a></li>
<li class="toctree-l2"><a class="reference internal" href="integrations.html#business-intelligence-with-tableau">Business Intelligence with Tableau</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Administer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/cluster_management.html">Cluster Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/cluster_management.html#choosing-cluster-size">Choosing Cluster Size</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#shard-count">Shard Count</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../admin_guide/cluster_management.html#multi-tenant-saas-use-case">Multi-Tenant SaaS Use-Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="../admin_guide/cluster_management.html#real-time-analytics-use-case">Real-Time Analytics Use-Case</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/cluster_management.html#initial-hardware-size">Initial Hardware Size</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#id2">Multi-Tenant SaaS Use-Case</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#id3">Real-Time Analytics Use-Case</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/cluster_management.html#scaling-the-cluster">Scaling the cluster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#add-a-worker">Add a worker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#rebalance-shards">Rebalance Shards</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#adding-a-coordinator">Adding a coordinator</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/cluster_management.html#dealing-with-node-failures">Dealing With Node Failures</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#worker-node-failures">Worker Node Failures</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#coordinator-node-failures">Coordinator Node Failures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/cluster_management.html#resource-conservation">Resource Conservation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#limiting-long-running-queries">Limiting Long-Running Queries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/cluster_management.html#security">Security</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#connection-management">Connection Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#setup-certificate-authority-signed-certificates">Setup Certificate Authority signed certificates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/cluster_management.html#increasing-worker-security">Increasing Worker Security</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/cluster_management.html#lightdb-extensions">LightDB extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/cluster_management.html#creating-a-new-database">Creating a New Database</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/table_management.html">Table Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/table_management.html#determining-table-and-relation-size">Determining Table and Relation Size</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/table_management.html#vacuuming-distributed-tables">Vacuuming Distributed Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/table_management.html#analyzing-distributed-tables">Analyzing Distributed Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/table_management.html#columnar-storage">Columnar Storage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/table_management.html#usage">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/table_management.html#measuring-compression">Measuring compression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/table_management.html#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/table_management.html#gotchas">Gotchas</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/table_management.html#limitations">Limitations</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Troubleshoot</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../performance/performance_tuning.html">Query Performance Tuning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../performance/performance_tuning.html#table-distribution-and-shards">Table Distribution and Shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/performance_tuning.html#lightdb-tuning">LightDB tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/performance_tuning.html#scaling-out-performance">Scaling Out Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/performance_tuning.html#distributed-query-performance-tuning">Distributed Query Performance Tuning</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance/performance_tuning.html#general">General</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#subquery-cte-network-overhead">Subquery/CTE Network Overhead</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../performance/performance_tuning.html#advanced">Advanced</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#connection-management">Connection Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#task-assignment-policy">Task Assignment Policy</a></li>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#intermediate-data-transfer-format">Intermediate Data Transfer Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#binary-protocol">Binary protocol</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../performance/performance_tuning.html#scaling-out-data-ingestion">Scaling Out Data Ingestion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../performance/performance_tuning.html#real-time-insert-and-updates">Real-time Insert and Updates</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#insert-throughput">Insert Throughput</a></li>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#update-throughput">Update Throughput</a></li>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#insert-and-update-throughput-checklist">Insert and Update: Throughput Checklist</a></li>
<li class="toctree-l4"><a class="reference internal" href="../performance/performance_tuning.html#insert-and-update-latency">Insert and Update: Latency</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../performance/performance_tuning.html#staging-data-temporarily">Staging Data Temporarily</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance/performance_tuning.html#bulk-copy-250k-2m-s">Bulk Copy (250K - 2M/s)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide/diagnostic_queries.html">Useful Diagnostic Queries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#finding-which-shard-contains-data-for-a-specific-tenant">Finding which shard contains data for a specific tenant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#finding-the-distribution-column-for-a-table">Finding the distribution column for a table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#detecting-locks">Detecting locks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#querying-the-size-of-your-shards">Querying the size of your shards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#querying-the-size-of-all-distributed-tables">Querying the size of all distributed tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#determining-replication-factor-per-table">Determining Replication Factor per Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#identifying-unused-indices">Identifying unused indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#monitoring-client-connection-count">Monitoring client connection count</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#viewing-system-queries">Viewing system queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#active-queries">Active queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#why-are-queries-waiting">Why are queries waiting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#index-hit-rate">Index hit rate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_guide/diagnostic_queries.html#cache-hit-rate">Cache hit rate</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/common_errors.html">Common Error Messages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#could-not-receive-query-results">Could not receive query results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#resolution">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#canceling-the-transaction-since-it-was-involved-in-a-distributed-deadlock">Canceling the transaction since it was involved in a distributed deadlock</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id1">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#could-not-connect-to-server-cannot-assign-requested-address">Could not connect to server: Cannot assign requested address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id2">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#ssl-error-certificate-verify-failed">SSL error: certificate verify failed</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id3">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#could-not-connect-to-any-active-placements">Could not connect to any active placements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id4">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#remaining-connection-slots-are-reserved-for-non-replication-superuser-connections">Remaining connection slots are reserved for non-replication superuser connections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id5">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#pgbouncer-cannot-connect-to-server">PgBouncer cannot connect to server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id6">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#cannot-create-uniqueness-constraint">Cannot create uniqueness constraint</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id7">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#function-create-distributed-table-does-not-exist">Function create_distributed_table does not exist</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id8">Resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/common_errors.html#stable-functions-used-in-update-queries-cannot-be-called-with-column-references">STABLE functions used in UPDATE queries cannot be called with column references</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/common_errors.html#id9">Resolution</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/faq.html">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#can-i-create-primary-keys-on-distributed-tables">Can I create primary keys on distributed tables?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#how-do-i-add-nodes-to-an-existing-canopy-cluster">How do I add nodes to an existing Canopy cluster?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#how-does-canopy-handle-failure-of-a-worker-node">How does Canopy handle failure of a worker node?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#how-does-canopy-handle-failover-of-the-coordinator-node">How does Canopy handle failover of the coordinator node?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#are-there-any-lightdb-features-not-supported-by-canopy">Are there any LightDB features not supported by Canopy?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#how-do-i-choose-the-shard-count-when-i-hash-partition-my-data">How do I choose the shard count when I hash-partition my data?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#how-do-i-change-the-shard-count-for-a-hash-partitioned-table">How do I change the shard count for a hash partitioned table?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#how-does-canopy-support-count-distinct-queries">How does canopy support count(distinct) queries?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#in-which-situations-are-uniqueness-constraints-supported-on-distributed-tables">In which situations are uniqueness constraints supported on distributed tables?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#how-do-i-create-database-roles-functions-extensions-etc-in-a-canopy-cluster">How do I create database roles, functions, extensions etc in a Canopy cluster?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#what-if-a-worker-node-s-address-changes">What if a worker node’s address changes?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#which-shard-contains-data-for-a-particular-tenant">Which shard contains data for a particular tenant?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#i-forgot-the-distribution-column-of-a-table-how-do-i-find-it">I forgot the distribution column of a table, how do I find it?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#can-i-distribute-a-table-by-multiple-keys">Can I distribute a table by multiple keys?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#why-does-pg-relation-size-report-zero-bytes-for-a-distributed-table">Why does pg_relation_size report zero bytes for a distributed table?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#why-am-i-seeing-an-error-about-max-intermediate-result-size">Why am I seeing an error about max_intermediate_result_size?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq.html#can-i-shard-by-schema-on-canopy-for-multi-tenant-applications">Can I shard by schema on Canopy for multi-tenant applications?</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Articles</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../articles/index.html">Related Articles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../articles/parallel_indexing.html">LightDB Parallel Indexing in Canopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../articles/aggregation.html">Real-time Event Aggregation at Scale Using LightDB with Canopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../articles/outer_joins.html">How Distributed Outer Joins on LightDB with Canopy Work</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../articles/outer_joins.html#distributed-outer-joins-with-canopy">Distributed Outer Joins with Canopy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../articles/designing_saas.html">Designing your SaaS Database for Scale with LightDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../articles/sharding_mt_app.html">Sharding a Multi-Tenant App with LightDB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../articles/sharding_mt_app.html#tenancy">Tenancy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../articles/sharding_mt_app.html#multi-tenancy-and-co-location-a-perfect-pair">Multi-tenancy and co-location, a perfect pair</a></li>
<li class="toctree-l3"><a class="reference internal" href="../articles/sharding_mt_app.html#in-conclusion">In conclusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../articles/semi_structured_data.html">Sharding LightDB with Semi-Structured Data and Its Performance Implications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../articles/semi_structured_data.html#one-large-table-without-joins">One large table, without joins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../articles/semi_structured_data.html#enter-canopy">Enter Canopy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../articles/semi_structured_data.html#the-query-workload">The query workload</a></li>
<li class="toctree-l3"><a class="reference internal" href="../articles/semi_structured_data.html#every-distribution-has-its-thorns">Every distribution has its thorns</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../articles/faceted_search.html">Scalable Real-time Product Search using LightDB with Canopy</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" aria-label="Top" >
          <button data-toggle="wy-nav-top" class="fa fa-bars"></button>
          <a href="../index.html">Canopy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          

<div role="navigation" aria-label="Breadcrumbs">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Documentation home page"></a> &raquo;</li>
          <li><a href="api.html">Canopy API</a> &raquo;</li>
      <li>Canopy Utility Functions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div id="maincontent" />

  
  <div class="section" id="canopy-utility-functions">
<span id="user-defined-functions"></span><h1>Canopy Utility Functions<a class="headerlink" href="#canopy-utility-functions" title="Permalink to this headline"></a></h1>
<p>This section contains reference information for the User Defined Functions provided by Canopy. These functions help in providing additional distributed functionality to Canopy other than the standard SQL commands.</p>
<div class="section" id="table-and-shard-ddl">
<h2>Table and Shard DDL<a class="headerlink" href="#table-and-shard-ddl" title="Permalink to this headline"></a></h2>
<div class="section" id="create-distributed-table">
<span id="id1"></span><h3>create_distributed_table<a class="headerlink" href="#create-distributed-table" title="Permalink to this headline"></a></h3>
<p>The create_distributed_table() function is used to define a distributed table
and create its shards if it’s a hash-distributed table. This function takes in a
table name, the distribution column and an optional distribution method and inserts
appropriate metadata to mark the table as distributed. The function defaults to
‘hash’ distribution if no distribution method is specified. If the table is
hash-distributed, the function also creates worker shards based on the shard
count and shard replication factor configuration values. If the table contains
any rows, they are automatically distributed to worker nodes.</p>
<div class="section" id="arguments">
<h4>Arguments<a class="headerlink" href="#arguments" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the table which needs to be distributed.</p>
<p><strong>distribution_column:</strong> The column on which the table is to be distributed.</p>
<p><strong>distribution_type:</strong> (Optional) The method according to which the table is
to be distributed. Permissible values are append or hash, and defaults to ‘hash’.</p>
<p><strong>colocate_with:</strong> (Optional) include current table in the co-location group of another table. By default tables are co-located when they are distributed by columns of the same type, have the same shard count, and have the same replication factor.
If you want to break this colocation later, you can use <a class="reference internal" href="#update-distributed-table-colocation"><span class="std std-ref">update_distributed_table_colocation</span></a>. Possible values for <code class="code docutils literal notranslate"><span class="pre">colocate_with</span></code> are <code class="code docutils literal notranslate"><span class="pre">default</span></code>, <code class="code docutils literal notranslate"><span class="pre">none</span></code> to start a new co-location group, or the name of another table to co-locate with that table.  (See <a class="reference internal" href="reference_ddl.html#colocation-groups"><span class="std std-ref">Co-Locating Tables</span></a>.)</p>
<p>Keep in mind that the default value of <code class="docutils literal notranslate"><span class="pre">colocate_with</span></code> does implicit co-location. As <a class="reference internal" href="../sharding/data_modeling.html#colocation"><span class="std std-ref">Table Co-Location</span></a> explains, this can be a great thing when tables are related or will be joined. However, when two tables are unrelated but happen to use the same datatype for their distribution columns, accidentally co-locating them can decrease performance during <a class="reference internal" href="../admin_guide/cluster_management.html#shard-rebalancing"><span class="std std-ref">shard rebalancing</span></a>. The table shards will be moved together unnecessarily in a “cascade.”
If you want to break this implicit colocation, you can use <a class="reference internal" href="#update-distributed-table-colocation"><span class="std std-ref">update_distributed_table_colocation</span></a>.</p>
<p>If a new distributed table is not related to other tables, it’s best to specify <code class="docutils literal notranslate"><span class="pre">colocate_with</span> <span class="pre">=&gt;</span> <span class="pre">'none'</span></code>.</p>
<p><strong>shard_count:</strong> (Optional) the number of shards to create for the new distributed table. When specifying <code class="docutils literal notranslate"><span class="pre">shard_count</span></code> you can’t specify a value of <code class="docutils literal notranslate"><span class="pre">colocate_with</span></code> other than <code class="docutils literal notranslate"><span class="pre">none</span></code>. To change the shard count of an existing table or colocation group, use the <a class="reference internal" href="#alter-distributed-table"><span class="std std-ref">alter_distributed_table</span></a> function.</p>
<p>Possible values for <code class="docutils literal notranslate"><span class="pre">shard_count</span></code> are between 1 and 64000. For guidance on choosing the optimal value, see <a class="reference internal" href="../admin_guide/cluster_management.html#prod-shard-count"><span class="std std-ref">Shard Count</span></a>.</p>
</div>
<div class="section" id="return-value">
<h4>Return Value<a class="headerlink" href="#return-value" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline"></a></h4>
<p>This example informs the database that the github_events table should be distributed by hash on the repo_id column.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">create_distributed_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;repo_id&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c1">-- alternatively, to be more explicit:</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">create_distributed_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;repo_id&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">colocate_with</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;github_repo&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>For more examples, see <a class="reference internal" href="reference_ddl.html#ddl"><span class="std std-ref">Creating and Modifying Distributed Tables (DDL)</span></a>.</p>
</div>
</div>
<div class="section" id="truncate-local-data-after-distributing-table">
<span id="id2"></span><h3>truncate_local_data_after_distributing_table<a class="headerlink" href="#truncate-local-data-after-distributing-table" title="Permalink to this headline"></a></h3>
<p>Truncate all local rows after distributing a table, and prevent constraints from failing due to outdated local records. The truncation cascades to tables having a foreign key to the designated table. If the referring tables are not themselves distributed then truncation is forbidden until they are, to protect referential integrity:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ERROR</span><span class="p">:</span>  <span class="n">cannot</span> <span class="n">truncate</span> <span class="n">a</span> <span class="n">table</span> <span class="n">referenced</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">foreign</span> <span class="n">key</span> <span class="n">constraint</span> <span class="n">by</span> <span class="n">a</span> <span class="n">local</span> <span class="n">table</span>
</pre></div>
</div>
<p>Truncating local coordinator node table data is safe for distributed tables because their rows, if they have any, are copied to worker nodes during distribution.</p>
<div class="section" id="id3">
<h4>Arguments<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the distributed table whose local counterpart on the coordinator node should be truncated.</p>
</div>
<div class="section" id="id4">
<h4>Return Value<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id5">
<h4>Example<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- requires that argument is a distributed table</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">truncate_local_data_after_distributing_table</span><span class="p">(</span><span class="s1">&#39;public.github_events&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="undistribute-table">
<span id="id6"></span><h3>undistribute_table<a class="headerlink" href="#undistribute-table" title="Permalink to this headline"></a></h3>
<p>The undistribute_table() function undoes the action of
<a class="reference internal" href="#create-distributed-table"><span class="std std-ref">create_distributed_table</span></a> or <a class="reference internal" href="#create-reference-table"><span class="std std-ref">create_reference_table</span></a>.
Undistributing moves all data from shards back into a local table on the
coordinator node (assuming the data can fit), then deletes the shards.</p>
<p>Canopy will not undistribute tables that have – or are referenced by – foreign
keys, unless the <cite>cascade_via_foreign_keys</cite> argument is set to true.
If this argument is false (or omitted), then you must manually drop the offending foreign
key constraints before undistributing.</p>
<div class="section" id="id7">
<h4>Arguments<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the distributed or reference table to undistribute.</p>
<p><strong>cascade_via_foreign_keys:</strong> (Optional) When this argument set to “true,” undistribute_table also
undistributes all tables that are related to <strong>table_name</strong> through foreign keys. Use caution with
this parameter, because it can potentially affect many tables.</p>
</div>
<div class="section" id="id8">
<h4>Return Value<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id9">
<h4>Example<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h4>
<p>This example distributes a <code class="docutils literal notranslate"><span class="pre">github_events</span></code> table and then undistributes it.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- first distribute the table</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">create_distributed_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;repo_id&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c1">-- undo that and make it local again</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">undistribute_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="alter-distributed-table">
<span id="id10"></span><h3>alter_distributed_table<a class="headerlink" href="#alter-distributed-table" title="Permalink to this headline"></a></h3>
<p>The alter_distributed_table() function can be used to change the distribution
column, shard count or colocation properties of a distributed table.</p>
<div class="section" id="id11">
<h4>Arguments<a class="headerlink" href="#id11" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the distributed table that will be altered.</p>
<p><strong>distribution_column:</strong> (Optional) Name of the new distribution column.</p>
<p><strong>shard_count:</strong> (Optional) The new shard count.</p>
<p><strong>colocate_with:</strong> (Optional) The table that the current distributed table will
be colocated with.  Possible values are <code class="docutils literal notranslate"><span class="pre">default</span></code>, <code class="docutils literal notranslate"><span class="pre">none</span></code> to start a new
colocation group, or the name of another table with which to colocate.</p>
<p><strong>cascade_to_colocated:</strong> (Optional) When this argument is set to “true”,
<code class="docutils literal notranslate"><span class="pre">shard_count</span></code> and <code class="docutils literal notranslate"><span class="pre">colocate_with</span></code> changes will also be applied to all of
the tables that were previously colocated with the table, and the colocation
will be preserved. If it is “false”, the current colocation of this table will
be broken.</p>
</div>
<div class="section" id="id12">
<h4>Return Value<a class="headerlink" href="#id12" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id13">
<h4>Example<a class="headerlink" href="#id13" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- change distribution column</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">alter_distributed_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">distribution_column</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;event_id&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c1">-- change shard count of all tables in colocation group</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">alter_distributed_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">shard_count</span><span class="p">:</span><span class="o">=</span><span class="mf">6</span><span class="p">,</span><span class="w"> </span><span class="n">cascade_to_colocated</span><span class="p">:</span><span class="o">=</span><span class="k">true</span><span class="p">);</span><span class="w"></span>

<span class="c1">-- change colocation</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">alter_distributed_table</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">colocate_with</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;another_table&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="alter-table-set-access-method">
<span id="id14"></span><h3>alter_table_set_access_method<a class="headerlink" href="#alter-table-set-access-method" title="Permalink to this headline"></a></h3>
<p>The alter_table_set_access_method() function changes access method of a table
(e.g. heap or <a class="reference internal" href="../admin_guide/table_management.html#columnar"><span class="std std-ref">columnar</span></a>).</p>
<div class="section" id="id15">
<h4>Arguments<a class="headerlink" href="#id15" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the table whose access method will change.</p>
<p><strong>access_method:</strong> Name of the new access method.</p>
</div>
<div class="section" id="id16">
<h4>Return Value<a class="headerlink" href="#id16" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id17">
<h4>Example<a class="headerlink" href="#id17" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">alter_table_set_access_method</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;columnar&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="remove-local-tables-from-metadata">
<span id="id18"></span><h3>remove_local_tables_from_metadata<a class="headerlink" href="#remove-local-tables-from-metadata" title="Permalink to this headline"></a></h3>
<p>The remove_local_tables_from_metadata() function removes local tables
from Canopy’ metadata that no longer need to be there. (See
<a class="reference internal" href="api_guc.html#enable-local-ref-fkeys"><span class="std std-ref">canopy.enable_local_reference_table_foreign_keys (boolean)</span></a>.)</p>
<p>Usually if a local table is in Canopy’ metadata, there’s a reason, such as
the existence of foreign keys between the table and a reference table.
However, if <code class="docutils literal notranslate"><span class="pre">enable_local_reference_foreign_keys</span></code> is disabled, Canopy
will no longer manage metadata in that situation, and unnecessary
metadata can persist until manually cleaned.</p>
<div class="section" id="id19">
<h4>Arguments<a class="headerlink" href="#id19" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id20">
<h4>Return Value<a class="headerlink" href="#id20" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
</div>
<div class="section" id="create-reference-table">
<span id="id21"></span><h3>create_reference_table<a class="headerlink" href="#create-reference-table" title="Permalink to this headline"></a></h3>
<p>The create_reference_table() function is used to define a small reference or
dimension table. This function takes in a table name, and creates a distributed
table with just one shard, replicated to every worker node.</p>
<div class="section" id="id22">
<h4>Arguments<a class="headerlink" href="#id22" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the small dimension or reference table which needs to be distributed.</p>
</div>
<div class="section" id="id23">
<h4>Return Value<a class="headerlink" href="#id23" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id24">
<h4>Example<a class="headerlink" href="#id24" title="Permalink to this headline"></a></h4>
<p>This example informs the database that the nation table should be defined as a
reference table</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">create_reference_table</span><span class="p">(</span><span class="s1">&#39;nation&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="mark-tables-colocated">
<span id="id25"></span><h3>mark_tables_colocated<a class="headerlink" href="#mark-tables-colocated" title="Permalink to this headline"></a></h3>
<p>The mark_tables_colocated() function takes a distributed table (the source), and a list of others (the targets), and puts the targets into the same co-location group as the source. If the source is not yet in a group, this function creates one, and assigns the source and targets to it.</p>
<p>Usually colocating tables ought to be done at table distribution time via the <code class="docutils literal notranslate"><span class="pre">colocate_with</span></code> parameter of <a class="reference internal" href="#create-distributed-table"><span class="std std-ref">create_distributed_table</span></a>. But <code class="docutils literal notranslate"><span class="pre">mark_tables_colocated</span></code> can take care of it if necessary.</p>
<p>If you want to break colocation of a table, you can use <a class="reference internal" href="#update-distributed-table-colocation"><span class="std std-ref">update_distributed_table_colocation</span></a>.</p>
<div class="section" id="id26">
<h4>Arguments<a class="headerlink" href="#id26" title="Permalink to this headline"></a></h4>
<p><strong>source_table_name:</strong> Name of the distributed table whose co-location group the targets will be assigned to match.</p>
<p><strong>target_table_names:</strong> Array of names of the distributed target tables, must be non-empty. These distributed tables must match the source table in:</p>
<blockquote>
<div><ul class="simple">
<li><p>distribution method</p></li>
<li><p>distribution column type</p></li>
<li><p>replication type</p></li>
<li><p>shard count</p></li>
</ul>
</div></blockquote>
<p>Failing this, Canopy will raise an error. For instance, attempting to colocate tables <code class="docutils literal notranslate"><span class="pre">apples</span></code> and <code class="docutils literal notranslate"><span class="pre">oranges</span></code> whose distribution column types differ results in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ERROR</span><span class="p">:</span>  <span class="n">cannot</span> <span class="n">colocate</span> <span class="n">tables</span> <span class="n">apples</span> <span class="ow">and</span> <span class="n">oranges</span>
<span class="n">DETAIL</span><span class="p">:</span>  <span class="n">Distribution</span> <span class="n">column</span> <span class="n">types</span> <span class="n">don</span><span class="s1">&#39;t match for apples and oranges.</span>
</pre></div>
</div>
</div>
<div class="section" id="id27">
<h4>Return Value<a class="headerlink" href="#id27" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id28">
<h4>Example<a class="headerlink" href="#id28" title="Permalink to this headline"></a></h4>
<p>This example puts <code class="docutils literal notranslate"><span class="pre">products</span></code> and <code class="docutils literal notranslate"><span class="pre">line_items</span></code> in the same co-location group as <code class="docutils literal notranslate"><span class="pre">stores</span></code>. The example assumes that these tables are all distributed on a column with matching type, most likely a “store id.”</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">mark_tables_colocated</span><span class="p">(</span><span class="s1">&#39;stores&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">ARRAY</span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;line_items&#39;</span><span class="p">]);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="update-distributed-table-colocation">
<span id="id29"></span><h3>update_distributed_table_colocation<a class="headerlink" href="#update-distributed-table-colocation" title="Permalink to this headline"></a></h3>
<p>The update_distributed_table_colocation() function is used to update colocation
of a distributed table. This function can also be used to break colocation of a
distributed table. Canopy will implicitly colocate two tables if the distribution
column is the same type, this can be useful if the tables are related and will
do some joins. If table A and B are colocated, and table A gets rebalanced, table B
will also be rebalanced. If table B does not have a replica identity, the rebalance will
fail. Therefore, this function can be useful breaking the implicit colocation in that case.</p>
<p>Both of the arguments should be a hash distributed table, currently we do not support colocation
of APPEND distributed tables.</p>
<p>Note that this function does not move any data around physically.</p>
<div class="section" id="id30">
<h4>Arguments<a class="headerlink" href="#id30" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the table colocation of which will be updated.</p>
<p><strong>colocate_with:</strong> The table to which the table should be colocated with.</p>
<p>If you want to break the colocation of a table, you should specify <code class="docutils literal notranslate"><span class="pre">colocate_with</span> <span class="pre">=&gt;</span> <span class="pre">'none'</span></code>.</p>
</div>
<div class="section" id="id31">
<h4>Return Value<a class="headerlink" href="#id31" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id32">
<h4>Example<a class="headerlink" href="#id32" title="Permalink to this headline"></a></h4>
<p>This example shows that colocation of <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">A</span></code> is updated as colocation of <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">B</span></code>.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">update_distributed_table_colocation</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">colocate_with</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Assume that <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">B</span></code> are colocated( possibily implicitly), if you want to break the colocation:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">update_distributed_table_colocation</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">colocate_with</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Now, assume that <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">A</span></code>, <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">B</span></code>, <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">D</span></code> are colocated and you want to colocate <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">A</span></code>
and <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">B</span></code> together, and <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">table</span> <span class="pre">D</span></code> together:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">update_distributed_table_colocation</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">colocate_with</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">);</span><span class="w"></span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">update_distributed_table_colocation</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">colocate_with</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;C&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>If you have a hash distributed table named <code class="docutils literal notranslate"><span class="pre">none</span></code> and you want to update its colocation, you can do:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">update_distributed_table_colocation</span><span class="p">(</span><span class="s1">&#39;&quot;none&quot;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">colocate_with</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;some_other_hash_distributed_table&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-distributed-function">
<span id="id33"></span><h3>create_distributed_function<a class="headerlink" href="#create-distributed-function" title="Permalink to this headline"></a></h3>
<p>Propagates a function from the coordinator node to workers, and marks it for
distributed execution. When a distributed function is called on the
coordinator, Canopy uses the value of the “distribution argument” to pick a
worker node to run the function. Executing the function on workers increases
parallelism, and can bring the code closer to data in shards for lower latency.</p>
<p>Note that the LightDB search path is not propagated from the coordinator to
workers during distributed function execution, so distributed function code
should fully-qualify the names of database objects. Also notices emitted by
the functions will not be displayed to the user.</p>
<div class="section" id="id34">
<h4>Arguments<a class="headerlink" href="#id34" title="Permalink to this headline"></a></h4>
<p><strong>function_name:</strong> Name of the function to be distributed. The name must
include the function’s parameter types in parentheses, because multiple
functions can have the same name in LightDB. For instance, <code class="docutils literal notranslate"><span class="pre">'foo(int)'</span></code> is
different from <code class="docutils literal notranslate"><span class="pre">'foo(int,</span> <span class="pre">text)'</span></code>.</p>
<p><strong>distribution_arg_name:</strong> (Optional) The argument name by which to distribute.
For convenience (or if the function arguments do not have names), a positional
placeholder is allowed, such as <code class="docutils literal notranslate"><span class="pre">'$1'</span></code>. If this parameter is not specified,
then the function named by <code class="docutils literal notranslate"><span class="pre">function_name</span></code> is merely created on the workers.
If worker nodes are added in the future the function will automatically be
created there too.</p>
<p><strong>colocate_with:</strong> (Optional) When the distributed function reads or writes to
a distributed table (or more generally <a class="reference internal" href="reference_ddl.html#colocation-groups"><span class="std std-ref">Co-Locating Tables</span></a>), be sure to
name that table using the <code class="docutils literal notranslate"><span class="pre">colocate_with</span></code> parameter. This ensures that each
invocation of the function runs on the worker node containing relevant shards.</p>
</div>
<div class="section" id="id35">
<h4>Return Value<a class="headerlink" href="#id35" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id36">
<h4>Example<a class="headerlink" href="#id36" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- an example function which updates a hypothetical</span>
<span class="c1">-- event_responses table which itself is distributed by event_id</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">REPLACE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"></span>
<span class="w">  </span><span class="n">register_for_event</span><span class="p">(</span><span class="n">p_event_id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">p_user_id</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"></span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">void</span><span class="w"> </span><span class="k">LANGUAGE</span><span class="w"> </span><span class="n">plpgsql</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">$</span><span class="dl">fn</span><span class="s">$</span><span class="w"></span>
<span class="k">BEGIN</span><span class="w"></span>
<span class="w">  </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">event_responses</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="nv">$1</span><span class="p">,</span><span class="w"> </span><span class="nv">$2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;yes&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="k">CONFLICT</span><span class="w"> </span><span class="p">(</span><span class="n">event_id</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">DO</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXCLUDED</span><span class="mf">.</span><span class="n">response</span><span class="p">;</span><span class="w"></span>
<span class="k">END</span><span class="p">;</span><span class="w"></span>
<span class="s">$</span><span class="dl">fn</span><span class="s">$</span><span class="p">;</span><span class="w"></span>

<span class="c1">-- distribute the function to workers, using the p_event_id argument</span>
<span class="c1">-- to determine which shard each invocation affects, and explicitly</span>
<span class="c1">-- colocating with event_responses which the function updates</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">create_distributed_function</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;register_for_event(int, int)&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p_event_id&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">colocate_with</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;event_responses&#39;</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="master-create-empty-shard">
<h3>master_create_empty_shard<a class="headerlink" href="#master-create-empty-shard" title="Permalink to this headline"></a></h3>
<p>The master_create_empty_shard() function can be used to create an empty shard for an <em>append</em> distributed table. Behind the covers, the function first selects shard_replication_factor workers to create the shard on. Then, it connects to the workers and creates empty placements for the shard on the selected workers. Finally, the metadata is updated for these placements on the coordinator to make these shards visible to future queries. The function errors out if it is unable to create the desired number of shard placements.</p>
<div class="section" id="id37">
<h4>Arguments<a class="headerlink" href="#id37" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the append distributed table for which the new shard is to be created.</p>
</div>
<div class="section" id="id38">
<h4>Return Value<a class="headerlink" href="#id38" title="Permalink to this headline"></a></h4>
<p><strong>shard_id:</strong> The function returns the unique id assigned to the newly created shard.</p>
</div>
<div class="section" id="id39">
<h4>Example<a class="headerlink" href="#id39" title="Permalink to this headline"></a></h4>
<p>This example creates an empty shard for the github_events table. The shard id of the created shard is 102089.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master_create_empty_shard</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">master_create_empty_shard</span><span class="w"></span>
<span class="c1">---------------------------</span>
<span class="w">                </span><span class="mf">102089</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="alter-columnar-table-set">
<span id="id40"></span><h3>alter_columnar_table_set<a class="headerlink" href="#alter-columnar-table-set" title="Permalink to this headline"></a></h3>
<p>The alter_columnar_table_set() function changes settings on a <a class="reference internal" href="../admin_guide/table_management.html#columnar"><span class="std std-ref">columnar
table</span></a>. Calling this function on a non-columnar table gives an
error. All arguments except the table name are optional.</p>
<p>To view current options for all columnar tables, consult this table:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">columnar</span><span class="mf">.</span><span class="k">options</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>The default values for columnar settings for newly-created tables can be
overridden with these GUCs:</p>
<ul class="simple">
<li><p>columnar.compression</p></li>
<li><p>columnar.compression_level</p></li>
<li><p>columnar.stripe_row_count</p></li>
<li><p>columnar.chunk_row_count</p></li>
</ul>
<div class="section" id="id41">
<h4>Arguments<a class="headerlink" href="#id41" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the columnar table.</p>
<p><strong>chunk_row_count:</strong> (Optional) The maximum number of rows per chunk for
newly-inserted data. Existing chunks of data will not be changed and may have
more rows than this maximum value. The default value is 10000.</p>
<p><strong>stripe_row_count:</strong> (Optional) The maximum number of rows per stripe for
newly-inserted data. Existing stripes of data will not be changed and may have
more rows than this maximum value. The default value is 150000.</p>
<p><strong>compression:</strong> (Optional) <code class="docutils literal notranslate"><span class="pre">[none|pglz|zstd|lz4|lz4hc]</span></code> The compression type
for newly-inserted data. Existing data will not be recompressed or
decompressed. The default and generally suggested value is zstd (if support has
been compiled in).</p>
<p><strong>compression_level:</strong> (Optional) Valid settings are from 1 through 19. If the
compression method does not support the level chosen, the closest level will be
selected instead.</p>
</div>
<div class="section" id="id42">
<h4>Return Value<a class="headerlink" href="#id42" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id43">
<h4>Example<a class="headerlink" href="#id43" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">alter_columnar_table_set</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;my_columnar_table&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">compression</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">stripe_row_count</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mf">10000</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-time-partitions">
<span id="id44"></span><h3>create_time_partitions<a class="headerlink" href="#create-time-partitions" title="Permalink to this headline"></a></h3>
<p>The create_time_partitions() function creates partitions of a given interval to
cover a given range of time.</p>
<div class="section" id="id45">
<h4>Arguments<a class="headerlink" href="#id45" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> (regclass) table for which to create new partitions. The table
must be partitioned on one column, of type date, timestamp, or timestamptz.</p>
<p><strong>partition_interval:</strong> an interval of time, such as <code class="docutils literal notranslate"><span class="pre">'2</span> <span class="pre">hours'</span></code>, or <code class="docutils literal notranslate"><span class="pre">'1</span>
<span class="pre">month'</span></code>, to use when setting ranges on new partitions.</p>
<p><strong>end_at:</strong> (timestamptz) create partitions up to this time. The last partition
will contain the point end_at, and no later partitions will be created.</p>
<p><strong>start_from:</strong> (timestamptz, optional) pick the first partition so that it
contains the point start_from. The default value is <code class="docutils literal notranslate"><span class="pre">now()</span></code>.</p>
</div>
<div class="section" id="id46">
<h4>Return Value<a class="headerlink" href="#id46" title="Permalink to this headline"></a></h4>
<p>True if it needed to create new partitions, false if they all existed already.</p>
</div>
<div class="section" id="id47">
<h4>Example<a class="headerlink" href="#id47" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- create a year&#39;s worth of monthly partitions</span>
<span class="c1">-- in table foo, starting from the current time</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">create_time_partitions</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">table_name</span><span class="w">         </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">partition_interval</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1 month&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">end_at</span><span class="w">             </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;12 months&#39;</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="drop-old-time-partitions">
<span id="id48"></span><h3>drop_old_time_partitions<a class="headerlink" href="#drop-old-time-partitions" title="Permalink to this headline"></a></h3>
<p>The drop_old_time_partitions() function removes all partitions whose intervals
fall before a given timestamp. In addition to using this function, you might
consider <a class="reference internal" href="#alter-old-partitions-set-access-method"><span class="std std-ref">alter_old_partitions_set_access_method</span></a> to compress the old
partitions with columnar storage.</p>
<div class="section" id="id49">
<h4>Arguments<a class="headerlink" href="#id49" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> (regclass) table for which to remove partitions. The table
must be partitioned on one column, of type date, timestamp, or timestamptz.</p>
<p><strong>older_than:</strong> (timestamptz) drop partitions whose upper range is less than
or equal to older_than.</p>
</div>
<div class="section" id="id50">
<h4>Return Value<a class="headerlink" href="#id50" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id51">
<h4>Example<a class="headerlink" href="#id51" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- drop partitions that are over a year old</span>

<span class="k">CALL</span><span class="w"> </span><span class="n">drop_old_time_partitions</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;12 months&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="alter-old-partitions-set-access-method">
<span id="id52"></span><h3>alter_old_partitions_set_access_method<a class="headerlink" href="#alter-old-partitions-set-access-method" title="Permalink to this headline"></a></h3>
<p>In a <a class="reference internal" href="../use_cases/timeseries.html#timeseries"><span class="std std-ref">Timeseries Data</span></a> use case, tables are often partitioned by time, and old
partitions are compressed into read-only columnar storage.</p>
<div class="section" id="id53">
<h4>Arguments<a class="headerlink" href="#id53" title="Permalink to this headline"></a></h4>
<p><strong>parent_table_name:</strong> (regclass) table for which to change partitions. The
table must be partitioned on one column, of type date, timestamp, or
timestamptz.</p>
<p><strong>older_than:</strong> (timestamptz) change partitions whose upper range is less than
or equal to older_than.</p>
<p><strong>new_access_method:</strong> (name) either <cite>‘heap’</cite> for row-based storage, or
<cite>‘columnar’</cite> for columnar storage.</p>
</div>
<div class="section" id="id54">
<h4>Return Value<a class="headerlink" href="#id54" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id55">
<h4>Example<a class="headerlink" href="#id55" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">CALL</span><span class="w"> </span><span class="n">alter_old_partitions_set_access_method</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;foo&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="s1">&#39;6 months&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="s1">&#39;columnar&#39;</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="table-and-shard-dml">
<h2>Table and Shard DML<a class="headerlink" href="#table-and-shard-dml" title="Permalink to this headline"></a></h2>
<div class="section" id="master-append-table-to-shard">
<span id="id56"></span><h3>master_append_table_to_shard<a class="headerlink" href="#master-append-table-to-shard" title="Permalink to this headline"></a></h3>
<p>The master_append_table_to_shard() function can be used to append a LightDB table’s contents to a shard of an <em>append</em> distributed table. Behind the covers, the function connects to each of the workers which have a placement of that shard and appends the contents of the table to each of them. Then, the function updates metadata for the shard placements on the basis of whether the append succeeded or failed on each of them.</p>
<p>If the function is able to successfully append to at least one shard placement, the function will return successfully. It will also mark any placement to which the append failed as INACTIVE so that any future queries do not consider that placement. If the append fails for all placements, the function quits with an error (as no data was appended). In this case, the metadata is left unchanged.</p>
<div class="section" id="id57">
<h4>Arguments<a class="headerlink" href="#id57" title="Permalink to this headline"></a></h4>
<p><strong>shard_id:</strong> Id of the shard to which the contents of the table have to be appended.</p>
<p><strong>source_table_name:</strong> Name of the LightDB table whose contents have to be appended.</p>
<p><strong>source_node_name:</strong> DNS name of the node on which the source table is present (“source” node).</p>
<p><strong>source_node_port:</strong> The port on the source worker node on which the database server is listening.</p>
</div>
<div class="section" id="id58">
<h4>Return Value<a class="headerlink" href="#id58" title="Permalink to this headline"></a></h4>
<p><strong>shard_fill_ratio:</strong> The function returns the fill ratio of the shard which is defined as the ratio of the current shard size to the configuration parameter shard_max_size.</p>
</div>
<div class="section" id="id59">
<h4>Example<a class="headerlink" href="#id59" title="Permalink to this headline"></a></h4>
<p>This example appends the contents of the github_events_local table to the shard having shard id 102089. The table github_events_local is present on the database running on the node master-101 on port number 5432. The function returns the ratio of the the current shard size to the maximum shard size, which is 0.1 indicating that 10% of the shard has been filled.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master_append_table_to_shard</span><span class="p">(</span><span class="mf">102089</span><span class="p">,</span><span class="s1">&#39;github_events_local&#39;</span><span class="p">,</span><span class="s1">&#39;master-101&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">master_append_table_to_shard</span><span class="w"></span>
<span class="c1">------------------------------</span>
<span class="w">                 </span><span class="mf">0.100548</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="master-apply-delete-command">
<h3>master_apply_delete_command<a class="headerlink" href="#master-apply-delete-command" title="Permalink to this headline"></a></h3>
<p>The master_apply_delete_command() function is used to delete shards which match the criteria specified by the delete command on an <em>append</em> distributed table. This function deletes a shard only if all rows in the shard match the delete criteria. As the function uses shard metadata to decide whether or not a shard needs to be deleted, it requires the WHERE clause in the DELETE statement to be on the distribution column. If no condition is specified, then all shards of that table are deleted.</p>
<p>Behind the covers, this function connects to all the worker nodes which have shards matching the delete criteria and sends them a command to drop the selected shards. Then, the function updates the corresponding metadata on the coordinator. If the function is able to successfully delete a shard placement, then the metadata for it is deleted. If a particular placement could not be deleted, then it is marked as TO DELETE. The placements which are marked as TO DELETE are not considered for future queries and can be cleaned up later.</p>
<div class="section" id="id60">
<h4>Arguments<a class="headerlink" href="#id60" title="Permalink to this headline"></a></h4>
<p><strong>delete_command:</strong> valid <a class="reference external" href="https://www.hs.net/lightdb/docs/html/sql-delete.html">SQL DELETE</a> command</p>
</div>
<div class="section" id="id61">
<h4>Return Value<a class="headerlink" href="#id61" title="Permalink to this headline"></a></h4>
<p><strong>deleted_shard_count:</strong> The function returns the number of shards which matched the criteria and were deleted (or marked for deletion). Note that this is the number of shards and not the number of shard placements.</p>
</div>
<div class="section" id="id62">
<h4>Example<a class="headerlink" href="#id62" title="Permalink to this headline"></a></h4>
<p>The first example deletes all the shards for the github_events table since no delete criteria is specified. In the second example, only the shards matching the criteria (3 in this case) are deleted.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master_apply_delete_command</span><span class="p">(</span><span class="s1">&#39;DELETE FROM github_events&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">master_apply_delete_command</span><span class="w"></span>
<span class="c1">-----------------------------</span>
<span class="w">                           </span><span class="mf">5</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master_apply_delete_command</span><span class="p">(</span><span class="s1">&#39;DELETE FROM github_events WHERE review_date &lt; &#39;&#39;2009-03-01&#39;&#39;&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">master_apply_delete_command</span><span class="w"></span>
<span class="c1">-----------------------------</span>
<span class="w">                           </span><span class="mf">3</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="metadata-configuration-information">
<h2>Metadata / Configuration Information<a class="headerlink" href="#metadata-configuration-information" title="Permalink to this headline"></a></h2>
<div class="section" id="canopy-add-node">
<span id="citus-add-node"></span><h3>canopy_add_node<a class="headerlink" href="#canopy-add-node" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function requires database superuser access to run.</p>
</div>
<p>The canopy_add_node() function registers a new node addition in the cluster in
the Canopy metadata table pg_dist_node. It also copies reference tables to the new node.</p>
<p>If running <code class="docutils literal notranslate"><span class="pre">canopy_add_node</span></code> on a single-node cluster, be sure to run
<a class="reference internal" href="#set-coordinator-host"><span class="std std-ref">canopy_set_coordinator_host</span></a> first.</p>
<div class="section" id="id63">
<h4>Arguments<a class="headerlink" href="#id63" title="Permalink to this headline"></a></h4>
<p><strong>nodename:</strong> DNS name or IP address of the new node to be added.</p>
<p><strong>nodeport:</strong> The port on which LightDB is listening on the worker node.</p>
<p><strong>groupid:</strong> A group of one primary server its secondary servers, relevant only
for streaming replication. Be sure to set <code class="docutils literal notranslate"><span class="pre">groupid</span></code> to a value greater than
zero, since zero is reserved for the coordinator node. The default is -1.</p>
<p><strong>noderole:</strong> Whether it is ‘primary’ or ‘secondary’. Default ‘primary’</p>
<p><strong>nodecluster:</strong> The cluster name. Default ‘default’</p>
</div>
<div class="section" id="id64">
<h4>Return Value<a class="headerlink" href="#id64" title="Permalink to this headline"></a></h4>
<p>The nodeid column from the newly inserted row in <a class="reference internal" href="api_metadata.html#pg-dist-node"><span class="std std-ref">pg_dist_node</span></a>.</p>
</div>
<div class="section" id="id65">
<h4>Example<a class="headerlink" href="#id65" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_add_node</span><span class="p">(</span><span class="s1">&#39;new-node&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">12345</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">canopy_add_node</span><span class="w"></span>
<span class="c1">-----------------</span>
<span class="w">               </span><span class="mf">7</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-update-node">
<span id="citus-update-node"></span><h3>canopy_update_node<a class="headerlink" href="#canopy-update-node" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function requires database superuser access to run.</p>
</div>
<p>The canopy_update_node() function changes the hostname and port for a node registered in the Canopy metadata table <a class="reference internal" href="api_metadata.html#pg-dist-node"><span class="std std-ref">pg_dist_node</span></a>.</p>
<div class="section" id="id66">
<h4>Arguments<a class="headerlink" href="#id66" title="Permalink to this headline"></a></h4>
<p><strong>node_id:</strong> id from the pg_dist_node table.</p>
<p><strong>node_name:</strong> updated DNS name or IP address for the node.</p>
<p><strong>node_port:</strong> the port on which LightDB is listening on the worker node.</p>
</div>
<div class="section" id="id67">
<h4>Return Value<a class="headerlink" href="#id67" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id68">
<h4>Example<a class="headerlink" href="#id68" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_update_node</span><span class="p">(</span><span class="mf">123</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;new-address&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-set-node-property">
<span id="citus-set-node-property"></span><h3>canopy_set_node_property<a class="headerlink" href="#canopy-set-node-property" title="Permalink to this headline"></a></h3>
<p>The canopy_set_node_property() function changes properties in the Canopy metadata table <a class="reference internal" href="api_metadata.html#pg-dist-node"><span class="std std-ref">pg_dist_node</span></a>. Currently it can change only the <code class="docutils literal notranslate"><span class="pre">shouldhaveshards</span></code> property.</p>
<div class="section" id="id69">
<h4>Arguments<a class="headerlink" href="#id69" title="Permalink to this headline"></a></h4>
<p><strong>node_name:</strong> DNS name or IP address for the node.</p>
<p><strong>node_port:</strong> the port on which LightDB is listening on the worker node.</p>
<p><strong>property:</strong> the column to change in <code class="docutils literal notranslate"><span class="pre">pg_dist_node</span></code>, currently only <code class="docutils literal notranslate"><span class="pre">shouldhaveshard</span></code> is supported.</p>
<p><strong>value:</strong> the new value for the column.</p>
</div>
<div class="section" id="id70">
<h4>Return Value<a class="headerlink" href="#id70" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id71">
<h4>Example<a class="headerlink" href="#id71" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">canopy_set_node_property</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5433</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shouldhaveshards&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">false</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-add-inactive-node">
<span id="citus-add-inactive-node"></span><h3>canopy_add_inactive_node<a class="headerlink" href="#canopy-add-inactive-node" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function requires database superuser access to run.</p>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">canopy_add_inactive_node</span></code> function, similar to <a class="reference internal" href="#citus-add-node"><span class="std std-ref">canopy_add_node</span></a>,
registers a new node in <code class="code docutils literal notranslate"><span class="pre">pg_dist_node</span></code>. However, it marks the new
node as inactive, meaning no shards will be placed there. Also it does
<em>not</em> copy reference tables to the new node.</p>
<div class="section" id="id72">
<h4>Arguments<a class="headerlink" href="#id72" title="Permalink to this headline"></a></h4>
<p><strong>nodename:</strong> DNS name or IP address of the new node to be added.</p>
<p><strong>nodeport:</strong> The port on which LightDB is listening on the worker node.</p>
<p><strong>groupid:</strong> A group of one primary server and zero or more secondary
servers, relevant only for streaming replication.  Default -1</p>
<p><strong>noderole:</strong> Whether it is ‘primary’ or ‘secondary’. Default ‘primary’</p>
<p><strong>nodecluster:</strong> The cluster name. Default ‘default’</p>
</div>
<div class="section" id="id73">
<h4>Return Value<a class="headerlink" href="#id73" title="Permalink to this headline"></a></h4>
<p>The nodeid column from the newly inserted row in <a class="reference internal" href="api_metadata.html#pg-dist-node"><span class="std std-ref">pg_dist_node</span></a>.</p>
</div>
<div class="section" id="id74">
<h4>Example<a class="headerlink" href="#id74" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_add_inactive_node</span><span class="p">(</span><span class="s1">&#39;new-node&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">12345</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">canopy_add_inactive_node</span><span class="w"></span>
<span class="c1">--------------------------</span>
<span class="w">                        </span><span class="mf">7</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-activate-node">
<span id="citus-activate-node"></span><h3>canopy_activate_node<a class="headerlink" href="#canopy-activate-node" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function requires database superuser access to run.</p>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">canopy_activate_node</span></code> function marks a node as active in the
Canopy metadata table <code class="code docutils literal notranslate"><span class="pre">pg_dist_node</span></code> and copies reference tables to
the node. Useful for nodes added via <a class="reference internal" href="#citus-add-inactive-node"><span class="std std-ref">canopy_add_inactive_node</span></a>.</p>
<div class="section" id="id75">
<h4>Arguments<a class="headerlink" href="#id75" title="Permalink to this headline"></a></h4>
<p><strong>nodename:</strong> DNS name or IP address of the new node to be added.</p>
<p><strong>nodeport:</strong> The port on which LightDB is listening on the worker node.</p>
</div>
<div class="section" id="id76">
<h4>Return Value<a class="headerlink" href="#id76" title="Permalink to this headline"></a></h4>
<p>The nodeid column from the newly inserted row in <a class="reference internal" href="api_metadata.html#pg-dist-node"><span class="std std-ref">pg_dist_node</span></a>.</p>
</div>
<div class="section" id="id77">
<h4>Example<a class="headerlink" href="#id77" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_activate_node</span><span class="p">(</span><span class="s1">&#39;new-node&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">12345</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">canopy_activate_node</span><span class="w"></span>
<span class="c1">----------------------</span>
<span class="w">                    </span><span class="mf">7</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-disable-node">
<h3>canopy_disable_node<a class="headerlink" href="#canopy-disable-node" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function requires database superuser access to run.</p>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">canopy_disable_node</span></code> function is the opposite of
<code class="code docutils literal notranslate"><span class="pre">canopy_activate_node</span></code>. It marks a node as inactive in
the Canopy metadata table <code class="code docutils literal notranslate"><span class="pre">pg_dist_node</span></code>, removing it from
the cluster temporarily. The function also deletes all reference table
placements from the disabled node. To reactivate the node, just run
<code class="code docutils literal notranslate"><span class="pre">canopy_activate_node</span></code> again.</p>
<div class="section" id="id78">
<h4>Arguments<a class="headerlink" href="#id78" title="Permalink to this headline"></a></h4>
<p><strong>nodename:</strong> DNS name or IP address of the node to be disabled.</p>
<p><strong>nodeport:</strong> The port on which LightDB is listening on the worker node.</p>
</div>
<div class="section" id="id79">
<h4>Return Value<a class="headerlink" href="#id79" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id80">
<h4>Example<a class="headerlink" href="#id80" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_disable_node</span><span class="p">(</span><span class="s1">&#39;new-node&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">12345</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-add-secondary-node">
<span id="citus-add-secondary-node"></span><h3>canopy_add_secondary_node<a class="headerlink" href="#canopy-add-secondary-node" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function requires database superuser access to run.</p>
</div>
<p>The canopy_add_secondary_node() function registers a new secondary
node in the cluster for an existing primary node. It updates the Canopy
metadata table pg_dist_node.</p>
<div class="section" id="id81">
<h4>Arguments<a class="headerlink" href="#id81" title="Permalink to this headline"></a></h4>
<p><strong>nodename:</strong> DNS name or IP address of the new node to be added.</p>
<p><strong>nodeport:</strong> The port on which LightDB is listening on the worker node.</p>
<p><strong>primaryname:</strong> DNS name or IP address of the primary node for this secondary.</p>
<p><strong>primaryport:</strong> The port on which LightDB is listening on the primary node.</p>
<p><strong>nodecluster:</strong> The cluster name. Default ‘default’</p>
</div>
<div class="section" id="id82">
<h4>Return Value<a class="headerlink" href="#id82" title="Permalink to this headline"></a></h4>
<p>The nodeid column for the secondary node, inserted row in <a class="reference internal" href="api_metadata.html#pg-dist-node"><span class="std std-ref">pg_dist_node</span></a>.</p>
</div>
<div class="section" id="id83">
<h4>Example<a class="headerlink" href="#id83" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_add_secondary_node</span><span class="p">(</span><span class="s1">&#39;new-node&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">12345</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;primary-node&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">12345</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">canopy_add_secondary_node</span><span class="w"></span>
<span class="c1">---------------------------</span>
<span class="w">                         </span><span class="mf">7</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-remove-node">
<h3>canopy_remove_node<a class="headerlink" href="#canopy-remove-node" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function requires database superuser access to run.</p>
</div>
<p>The canopy_remove_node() function removes the specified node from the
pg_dist_node metadata table. This function will error out if there
are existing shard placements on this node. Thus, before using this
function, the shards will need to be moved off that node.</p>
<div class="section" id="id84">
<h4>Arguments<a class="headerlink" href="#id84" title="Permalink to this headline"></a></h4>
<p><strong>nodename:</strong> DNS name of the node to be removed.</p>
<p><strong>nodeport:</strong> The port on which LightDB is listening on the worker node.</p>
</div>
<div class="section" id="id85">
<h4>Return Value<a class="headerlink" href="#id85" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id86">
<h4>Example<a class="headerlink" href="#id86" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">canopy_remove_node</span><span class="p">(</span><span class="s1">&#39;new-node&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">12345</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">canopy_remove_node</span><span class="w"></span>
<span class="c1">--------------------</span>

<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-get-active-worker-nodes">
<h3>canopy_get_active_worker_nodes<a class="headerlink" href="#canopy-get-active-worker-nodes" title="Permalink to this headline"></a></h3>
<p>The canopy_get_active_worker_nodes() function returns a list of active worker
host names and port numbers.</p>
<div class="section" id="id87">
<h4>Arguments<a class="headerlink" href="#id87" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id88">
<h4>Return Value<a class="headerlink" href="#id88" title="Permalink to this headline"></a></h4>
<p>List of tuples where each tuple contains the following information:</p>
<p><strong>node_name:</strong> DNS name of the worker node</p>
<p><strong>node_port:</strong> Port on the worker node on which the database server is listening</p>
</div>
<div class="section" id="id89">
<h4>Example<a class="headerlink" href="#id89" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_get_active_worker_nodes</span><span class="p">();</span><span class="w"></span>
<span class="w"> </span><span class="n">node_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">node_port</span><span class="w"></span>
<span class="c1">-----------+-----------</span>
<span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mf">9700</span><span class="w"></span>
<span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mf">9702</span><span class="w"></span>
<span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mf">9701</span><span class="w"></span>

<span class="p">(</span><span class="mf">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-set-coordinator-host">
<span id="set-coordinator-host"></span><h3>canopy_set_coordinator_host<a class="headerlink" href="#canopy-set-coordinator-host" title="Permalink to this headline"></a></h3>
<p>This function is required when adding worker nodes to a Canopy cluster which was
created initially as a <a class="reference internal" href="../installation/single_node.html#development"><span class="std std-ref">single-node cluster</span></a>. When the
coordinator registers a new worker, it adds a coordinator hostname from the
value of <a class="reference internal" href="api_guc.html#local-hostname"><span class="std std-ref">canopy.local_hostname (text)</span></a>, which is by default <code class="docutils literal notranslate"><span class="pre">localhost</span></code>. The worker
would attempt to connect to <code class="docutils literal notranslate"><span class="pre">localhost</span></code> to talk to the coordinator, which is
obviously wrong.</p>
<p>Thus, the system administrator should call <code class="docutils literal notranslate"><span class="pre">canopy_set_coordinator_host</span></code>
before calling <a class="reference internal" href="#citus-add-node"><span class="std std-ref">canopy_add_node</span></a> in a single-node cluster.</p>
<div class="section" id="id90">
<h4>Arguments<a class="headerlink" href="#id90" title="Permalink to this headline"></a></h4>
<p><strong>host:</strong> DNS name of the coordinator node.</p>
<p><strong>port:</strong> (Optional) The port on which the coordinator lists for LightDB
connections. Defaults to <code class="docutils literal notranslate"><span class="pre">current_setting('port')</span></code>.</p>
<p><strong>node_role:</strong> (Optional) Defaults to <code class="docutils literal notranslate"><span class="pre">primary</span></code>.</p>
<p><strong>node_cluster:</strong> (Optional) Defaults to <code class="docutils literal notranslate"><span class="pre">default</span></code>.</p>
</div>
<div class="section" id="id91">
<h4>Return Value<a class="headerlink" href="#id91" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id92">
<h4>Example<a class="headerlink" href="#id92" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- assuming we&#39;re in a single-node cluster</span>

<span class="c1">-- first establish how workers should reach us</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">canopy_set_coordinator_host</span><span class="p">(</span><span class="s1">&#39;coord.example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">);</span><span class="w"></span>

<span class="c1">-- then add a worker</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">canopy_add_node</span><span class="p">(</span><span class="s1">&#39;worker1.example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="master-get-table-metadata">
<h3>master_get_table_metadata<a class="headerlink" href="#master-get-table-metadata" title="Permalink to this headline"></a></h3>
<p>The master_get_table_metadata() function can be used to return distribution related metadata for a distributed table. This metadata includes the relation id, storage type, distribution method, distribution column, replication count, maximum shard size and the shard placement policy for that table. Behind the covers, this function queries Canopy metadata tables to get the required information and concatenates it into a tuple before returning it to the user.</p>
<div class="section" id="id93">
<h4>Arguments<a class="headerlink" href="#id93" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> Name of the distributed table for which you want to fetch metadata.</p>
</div>
<div class="section" id="id94">
<h4>Return Value<a class="headerlink" href="#id94" title="Permalink to this headline"></a></h4>
<p>A tuple containing the following information:</p>
<p><strong>logical_relid:</strong> Oid of the distributed table. This values references the relfilenode column in the pg_class system catalog table.</p>
<p><strong>part_storage_type:</strong> Type of storage used for the table. May be ‘t’ (standard table), ‘f’ (foreign table) or ‘c’ (columnar table).</p>
<p><strong>part_method:</strong> Distribution method used for the table. May be ‘a’ (append), or ‘h’ (hash).</p>
<p><strong>part_key:</strong> Distribution column for the table.</p>
<p><strong>part_replica_count:</strong> Current shard replication count.</p>
<p><strong>part_max_size:</strong> Current maximum shard size in bytes.</p>
<p><strong>part_placement_policy:</strong> Shard placement policy used for placing the table’s shards. May be 1 (local-node-first) or 2 (round-robin).</p>
</div>
<div class="section" id="id95">
<h4>Example<a class="headerlink" href="#id95" title="Permalink to this headline"></a></h4>
<p>The example below fetches and displays the table metadata for the github_events table.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master_get_table_metadata</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="n">logical_relid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">part_storage_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">part_method</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">part_key</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">part_replica_count</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">part_max_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">part_placement_policy</span><span class="w"></span>
<span class="c1">---------------+-------------------+-------------+----------+--------------------+---------------+-----------------------</span>
<span class="w">         </span><span class="mf">24180</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="n">h</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">repo_id</span><span class="w">  </span><span class="o">|</span><span class="w">                  </span><span class="mf">2</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mf">1073741824</span><span class="w"> </span><span class="o">|</span><span class="w">                     </span><span class="mf">2</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="get-shard-id-for-distribution-column">
<span id="get-shard-id"></span><h3>get_shard_id_for_distribution_column<a class="headerlink" href="#get-shard-id-for-distribution-column" title="Permalink to this headline"></a></h3>
<p>Canopy assigns every row of a distributed table to a shard based on the value of the row’s distribution column and the table’s method of distribution. In most cases the precise mapping is a low-level detail that the database administrator can ignore. However, it can be useful to determine a row’s shard, either for manual database maintenance tasks or just to satisfy curiosity. The <code class="code docutils literal notranslate"><span class="pre">get_shard_id_for_distribution_column</span></code> function provides this info for hash-distributed tables as well as reference tables. It does not work for the append distribution.</p>
<div class="section" id="id96">
<h4>Arguments<a class="headerlink" href="#id96" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> The distributed table.</p>
<p><strong>distribution_value:</strong> The value of the distribution column.</p>
</div>
<div class="section" id="id97">
<h4>Return Value<a class="headerlink" href="#id97" title="Permalink to this headline"></a></h4>
<p>The shard id Canopy associates with the distribution column value for the given table.</p>
</div>
<div class="section" id="id98">
<h4>Example<a class="headerlink" href="#id98" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">get_shard_id_for_distribution_column</span><span class="p">(</span><span class="s1">&#39;my_table&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span><span class="w"></span>

<span class="w"> </span><span class="n">get_shard_id_for_distribution_column</span><span class="w"></span>
<span class="c1">--------------------------------------</span>
<span class="w">                               </span><span class="mf">540007</span><span class="w"></span>
<span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="column-to-column-name">
<h3>column_to_column_name<a class="headerlink" href="#column-to-column-name" title="Permalink to this headline"></a></h3>
<p>Translates the <code class="code docutils literal notranslate"><span class="pre">partkey</span></code> column of <code class="code docutils literal notranslate"><span class="pre">pg_dist_partition</span></code> into a textual column name. This is useful to determine the distribution column of a distributed table.</p>
<p>For a more detailed discussion, see <a class="reference internal" href="../admin_guide/diagnostic_queries.html#finding-dist-col"><span class="std std-ref">Finding the distribution column for a table</span></a>.</p>
<div class="section" id="id99">
<h4>Arguments<a class="headerlink" href="#id99" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> The distributed table.</p>
<p><strong>column_var_text:</strong> The value of <code class="code docutils literal notranslate"><span class="pre">partkey</span></code> in the <code class="code docutils literal notranslate"><span class="pre">pg_dist_partition</span></code> table.</p>
</div>
<div class="section" id="id100">
<h4>Return Value<a class="headerlink" href="#id100" title="Permalink to this headline"></a></h4>
<p>The name of <code class="code docutils literal notranslate"><span class="pre">table_name</span></code>’s distribution column.</p>
</div>
<div class="section" id="id101">
<h4>Example<a class="headerlink" href="#id101" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- get distribution column name for products table</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">column_to_column_name</span><span class="p">(</span><span class="n">logicalrelid</span><span class="p">,</span><span class="w"> </span><span class="n">partkey</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dist_col_name</span><span class="w"></span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_dist_partition</span><span class="w"></span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">logicalrelid</span><span class="o">=</span><span class="s1">&#39;products&#39;</span><span class="o">::</span><span class="n">regclass</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───────────────┐
│ dist_col_name │
├───────────────┤
│ company_id    │
└───────────────┘
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-relation-size">
<h3>canopy_relation_size<a class="headerlink" href="#canopy-relation-size" title="Permalink to this headline"></a></h3>
<p>Get the disk space used by all the shards of the specified distributed table. This includes the size of the “main fork,” but excludes the visibility map and free space map for the shards.</p>
<div class="section" id="id102">
<h4>Arguments<a class="headerlink" href="#id102" title="Permalink to this headline"></a></h4>
<p><strong>logicalrelid:</strong> the name of a distributed table.</p>
</div>
<div class="section" id="id103">
<h4>Return Value<a class="headerlink" href="#id103" title="Permalink to this headline"></a></h4>
<p>Size in bytes as a bigint.</p>
</div>
<div class="section" id="id104">
<h4>Example<a class="headerlink" href="#id104" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">canopy_relation_size</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pg_size_pretty</span>
<span class="o">--------------</span>
<span class="mi">23</span> <span class="n">MB</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-table-size">
<h3>canopy_table_size<a class="headerlink" href="#canopy-table-size" title="Permalink to this headline"></a></h3>
<p>Get the disk space used by all the shards of the specified distributed table, excluding indexes (but including TOAST, free space map, and visibility map).</p>
<div class="section" id="id105">
<h4>Arguments<a class="headerlink" href="#id105" title="Permalink to this headline"></a></h4>
<p><strong>logicalrelid:</strong> the name of a distributed table.</p>
</div>
<div class="section" id="id106">
<h4>Return Value<a class="headerlink" href="#id106" title="Permalink to this headline"></a></h4>
<p>Size in bytes as a bigint.</p>
</div>
<div class="section" id="id107">
<h4>Example<a class="headerlink" href="#id107" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">canopy_table_size</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pg_size_pretty</span>
<span class="o">--------------</span>
<span class="mi">37</span> <span class="n">MB</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-total-relation-size">
<h3>canopy_total_relation_size<a class="headerlink" href="#canopy-total-relation-size" title="Permalink to this headline"></a></h3>
<p>Get the total disk space used by the all the shards of the specified distributed table, including all indexes and TOAST data.</p>
<div class="section" id="id108">
<h4>Arguments<a class="headerlink" href="#id108" title="Permalink to this headline"></a></h4>
<p><strong>logicalrelid:</strong> the name of a distributed table.</p>
</div>
<div class="section" id="id109">
<h4>Return Value<a class="headerlink" href="#id109" title="Permalink to this headline"></a></h4>
<p>Size in bytes as a bigint.</p>
</div>
<div class="section" id="id110">
<h4>Example<a class="headerlink" href="#id110" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">canopy_total_relation_size</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pg_size_pretty</span>
<span class="o">--------------</span>
<span class="mi">73</span> <span class="n">MB</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="cluster-management-and-repair-functions">
<span id="cluster-management-functions"></span><h2>Cluster Management And Repair Functions<a class="headerlink" href="#cluster-management-and-repair-functions" title="Permalink to this headline"></a></h2>
<div class="section" id="canopy-copy-shard-placement">
<h3>canopy_copy_shard_placement<a class="headerlink" href="#canopy-copy-shard-placement" title="Permalink to this headline"></a></h3>
<p>If a shard placement fails to be updated during a modification command or a DDL operation, then it gets marked as inactive. The canopy_copy_shard_placement function can then be called to repair an inactive shard placement using data from a healthy placement.</p>
<p>To repair a shard, the function first drops the unhealthy shard placement and recreates it using the schema on the coordinator. Once the shard placement is created, the function copies data from the healthy placement and updates the metadata to mark the new shard placement as healthy. This function ensures that the shard will be protected from any concurrent modifications during the repair.</p>
<div class="section" id="id111">
<h4>Arguments<a class="headerlink" href="#id111" title="Permalink to this headline"></a></h4>
<p><strong>shard_id:</strong> Id of the shard to be repaired.</p>
<p><strong>source_node_name:</strong> DNS name of the node on which the healthy shard placement is present (“source” node).</p>
<p><strong>source_node_port:</strong> The port on the source worker node on which the database server is listening.</p>
<p><strong>target_node_name:</strong> DNS name of the node on which the invalid shard placement is present (“target” node).</p>
<p><strong>target_node_port:</strong> The port on the target worker node on which the database server is listening.</p>
</div>
<div class="section" id="id112">
<h4>Return Value<a class="headerlink" href="#id112" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id113">
<h4>Example<a class="headerlink" href="#id113" title="Permalink to this headline"></a></h4>
<p>The example below will repair an inactive shard placement of shard 12345 which is present on the database server running on ‘bad_host’ on port 5432. To repair it, it will use data from a healthy shard placement present on the server running on ‘good_host’ on port 5432.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">canopy_copy_shard_placement</span><span class="p">(</span><span class="mf">12345</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;good_host&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;bad_host&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-move-shard-placement">
<h3>canopy_move_shard_placement<a class="headerlink" href="#canopy-move-shard-placement" title="Permalink to this headline"></a></h3>
<p>This function moves a given shard (and shards co-located with it) from one node to another. It is typically used indirectly during shard rebalancing rather than being called directly by a database administrator.</p>
<p>There are two ways to move the data: blocking or nonblocking. The blocking approach means that during the move all modifications to the shard are paused. The second way, which avoids blocking shard writes, relies on LightDB 10 logical replication.</p>
<p>After a successful move operation, shards in the source node get deleted. If the move fails at any point, this function throws an error and leaves the source and target nodes unchanged.</p>
<div class="section" id="id114">
<h4>Arguments<a class="headerlink" href="#id114" title="Permalink to this headline"></a></h4>
<p><strong>shard_id:</strong> Id of the shard to be moved.</p>
<p><strong>source_node_name:</strong> DNS name of the node on which the healthy shard placement is present (“source” node).</p>
<p><strong>source_node_port:</strong> The port on the source worker node on which the database server is listening.</p>
<p><strong>target_node_name:</strong> DNS name of the node on which the invalid shard placement is present (“target” node).</p>
<p><strong>target_node_port:</strong> The port on the target worker node on which the database server is listening.</p>
<p><strong>shard_transfer_mode:</strong> (Optional) Specify the method of replication, whether to use LightDB logical replication or a cross-worker COPY command. The possible values are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">auto</span></code>: Require replica identity if logical replication is possible, otherwise use legacy behaviour. This is the default value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">force_logical</span></code>: Use logical replication even if the table doesn’t have a replica identity. Any concurrent update/delete statements to the table will fail during replication.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">block_writes</span></code>: Use COPY (blocking writes) for tables lacking primary key or replica identity.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Canopy supports only the <code class="docutils literal notranslate"><span class="pre">block_writes</span></code> mode, and treats <code class="docutils literal notranslate"><span class="pre">auto</span></code> as <code class="docutils literal notranslate"><span class="pre">block_writes</span></code>.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id115">
<h4>Return Value<a class="headerlink" href="#id115" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id116">
<h4>Example<a class="headerlink" href="#id116" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">canopy_move_shard_placement</span><span class="p">(</span><span class="mf">12345</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;from_host&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to_host&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="rebalance-table-shards">
<span id="id117"></span><h3>rebalance_table_shards<a class="headerlink" href="#rebalance-table-shards" title="Permalink to this headline"></a></h3>
<p>The rebalance_table_shards() function moves shards of the given table to make
them evenly distributed among the workers. The function first calculates the
list of moves it needs to make in order to ensure that the cluster is balanced
within the given threshold. Then, it moves shard placements one by one from the
source node to the destination node and updates the corresponding shard
metadata to reflect the move.</p>
<p>Every shard is assigned a cost when determining whether shards are “evenly
distributed.” By default each shard has the same cost (a value of 1), so
distributing to equalize the cost across workers is the same as equalizing the
number of shards on each. The constant cost strategy is called “by_shard_count”
and is the default rebalancing strategy.</p>
<p>The default strategy is appropriate under these circumstances:</p>
<ol class="arabic simple">
<li><p>The shards are roughly the same size</p></li>
<li><p>The shards get roughly the same amount of traffic</p></li>
<li><p>Worker nodes are all the same size/type</p></li>
<li><p>Shards haven’t been pinned to particular workers</p></li>
</ol>
<p>If any of these assumptions don’t hold, then the default rebalancing can result
in a bad plan. In this case you may customize the strategy, using the
<code class="docutils literal notranslate"><span class="pre">rebalance_strategy</span></code> parameter.</p>
<p>It’s advisable to call <a class="reference internal" href="#get-rebalance-table-shards-plan"><span class="std std-ref">get_rebalance_table_shards_plan</span></a> before running
rebalance_table_shards, to see and verify the actions to be performed.</p>
<div class="section" id="id118">
<h4>Arguments<a class="headerlink" href="#id118" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> (Optional) The name of the table whose shards need to be rebalanced. If NULL, then rebalance all existing colocation groups.</p>
<p><strong>threshold:</strong> (Optional) A float number between 0.0 and 1.0 which indicates the maximum difference ratio of node utilization from average utilization. For example, specifying 0.1 will cause the shard rebalancer to attempt to balance all nodes to hold the same number of shards ±10%. Specifically, the shard rebalancer will try to converge utilization of all worker nodes to the (1 - threshold) * average_utilization … (1 + threshold) * average_utilization range.</p>
<p><strong>max_shard_moves:</strong> (Optional) The maximum number of shards to move.</p>
<p><strong>excluded_shard_list:</strong> (Optional) Identifiers of shards which shouldn’t be moved during the rebalance operation.</p>
<p><strong>shard_transfer_mode:</strong> (Optional) Specify the method of replication, whether to use LightDB logical replication or a cross-worker COPY command. The possible values are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">auto</span></code>: Require replica identity if logical replication is possible, otherwise use legacy behaviour. This is the default value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">force_logical</span></code>: Use logical replication even if the table doesn’t have a replica identity. Any concurrent update/delete statements to the table will fail during replication.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">block_writes</span></code>: Use COPY (blocking writes) for tables lacking primary key or replica identity.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Canopy supports only the <code class="docutils literal notranslate"><span class="pre">block_writes</span></code> mode, and treats <code class="docutils literal notranslate"><span class="pre">auto</span></code> as <code class="docutils literal notranslate"><span class="pre">block_writes</span></code>.</p>
</div>
</div></blockquote>
<p><strong>drain_only:</strong> (Optional) When true, move shards off worker nodes who have <code class="docutils literal notranslate"><span class="pre">shouldhaveshards</span></code> set to false in <a class="reference internal" href="api_metadata.html#pg-dist-node"><span class="std std-ref">Worker node table</span></a>; move no other shards.</p>
<p><strong>rebalance_strategy:</strong> (Optional) the name of a strategy in <a class="reference internal" href="api_metadata.html#pg-dist-rebalance-strategy"><span class="std std-ref">Rebalancer strategy table</span></a>. If this argument is omitted, the function chooses the default strategy, as indicated in the table.</p>
</div>
<div class="section" id="id119">
<h4>Return Value<a class="headerlink" href="#id119" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id120">
<h4>Example<a class="headerlink" href="#id120" title="Permalink to this headline"></a></h4>
<p>The example below will attempt to rebalance the shards of the github_events table within the default threshold.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">rebalance_table_shards</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>This example usage will attempt to rebalance the github_events table without moving shards with id 1 and 2.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">rebalance_table_shards</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">excluded_shard_list</span><span class="p">:</span><span class="o">=</span><span class="s1">&#39;{1,2}&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="get-rebalance-table-shards-plan">
<span id="id121"></span><h3>get_rebalance_table_shards_plan<a class="headerlink" href="#get-rebalance-table-shards-plan" title="Permalink to this headline"></a></h3>
<p>Output the planned shard movements of <a class="reference internal" href="#rebalance-table-shards"><span class="std std-ref">rebalance_table_shards</span></a> without
performing them. While it’s unlikely, get_rebalance_table_shards_plan can
output a slightly different plan than what a rebalance_table_shards call with
the same arguments will do. This could happen because they are not executed at
the same time, so facts about the cluster – e.g. disk space – might differ
between the calls.</p>
<div class="section" id="id122">
<h4>Arguments<a class="headerlink" href="#id122" title="Permalink to this headline"></a></h4>
<p>The same arguments as rebalance_table_shards: relation, threshold,
max_shard_moves, excluded_shard_list, and drain_only. See documentation of that
function for the arguments’ meaning.</p>
</div>
<div class="section" id="id123">
<h4>Return Value<a class="headerlink" href="#id123" title="Permalink to this headline"></a></h4>
<p>Tuples containing these columns:</p>
<ul class="simple">
<li><p><strong>table_name</strong>: The table whose shards would move</p></li>
<li><p><strong>shardid</strong>: The shard in question</p></li>
<li><p><strong>shard_size</strong>: Size in bytes</p></li>
<li><p><strong>sourcename</strong>: Hostname of the source node</p></li>
<li><p><strong>sourceport</strong>: Port of the source node</p></li>
<li><p><strong>targetname</strong>: Hostname of the destination node</p></li>
<li><p><strong>targetport</strong>: Port of the destination node</p></li>
</ul>
</div>
</div>
<div class="section" id="get-rebalance-progress">
<span id="id124"></span><h3>get_rebalance_progress<a class="headerlink" href="#get-rebalance-progress" title="Permalink to this headline"></a></h3>
<p>Once a shard rebalance begins, the <code class="docutils literal notranslate"><span class="pre">get_rebalance_progress()</span></code> function lists the progress of every shard involved. It monitors the moves planned and executed by <code class="docutils literal notranslate"><span class="pre">rebalance_table_shards()</span></code>.</p>
<div class="section" id="id125">
<h4>Arguments<a class="headerlink" href="#id125" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id126">
<h4>Return Value<a class="headerlink" href="#id126" title="Permalink to this headline"></a></h4>
<p>Tuples containing these columns:</p>
<ul class="simple">
<li><p><strong>sessionid</strong>: LightDB PID of the rebalance monitor</p></li>
<li><p><strong>table_name</strong>: The table whose shards are moving</p></li>
<li><p><strong>shardid</strong>: The shard in question</p></li>
<li><p><strong>shard_size</strong>: Size of the shard in bytes</p></li>
<li><p><strong>sourcename</strong>: Hostname of the source node</p></li>
<li><p><strong>sourceport</strong>: Port of the source node</p></li>
<li><p><strong>targetname</strong>: Hostname of the destination node</p></li>
<li><p><strong>targetport</strong>: Port of the destination node</p></li>
<li><p><strong>progress</strong>: 0 = waiting to be moved; 1 = moving; 2 = complete</p></li>
<li><p><strong>source_shard_size</strong>: Size of the shard on the source node in bytes</p></li>
<li><p><strong>target_shard_size</strong>: Size of the shard on the target node in bytes</p></li>
</ul>
</div>
<div class="section" id="id127">
<h4>Example<a class="headerlink" href="#id127" title="Permalink to this headline"></a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">get_rebalance_progress</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌───────────┬────────────┬─────────┬────────────┬───────────────┬────────────┬───────────────┬────────────┬──────────┬───────────────────┬───────────────────┐
│ sessionid │ table_name │ shardid │ shard_size │  sourcename   │ sourceport │  targetname   │ targetport │ progress │ source_shard_size │ target_shard_size │
├───────────┼────────────┼─────────┼────────────┼───────────────┼────────────┼───────────────┼────────────┼──────────┼───────────────────┼───────────────────┤
│      7083 │ foo        │  102008 │    1204224 │ n1.foobar.com │       5432 │ n4.foobar.com │       5432 │        0 │           1204224 │                 0 │
│      7083 │ foo        │  102009 │    1802240 │ n1.foobar.com │       5432 │ n4.foobar.com │       5432 │        0 │           1802240 │                 0 │
│      7083 │ foo        │  102018 │     614400 │ n2.foobar.com │       5432 │ n4.foobar.com │       5432 │        1 │            614400 │            354400 │
│      7083 │ foo        │  102019 │       8192 │ n3.foobar.com │       5432 │ n4.foobar.com │       5432 │        2 │                 0 │              8192 │
└───────────┴────────────┴─────────┴────────────┴───────────────┴────────────┴───────────────┴────────────┴──────────┴───────────────────┴───────────────────┘
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-add-rebalance-strategy">
<span id="citus-add-rebalance-strategy"></span><h3>canopy_add_rebalance_strategy<a class="headerlink" href="#canopy-add-rebalance-strategy" title="Permalink to this headline"></a></h3>
<p>Append a row to the <code class="docutils literal notranslate"><span class="pre">pg_dist_rebalance_strategy</span></code>.</p>
<div class="section" id="id128">
<h4>Arguments<a class="headerlink" href="#id128" title="Permalink to this headline"></a></h4>
<p>For more about these arguments, see the corresponding column values in <a class="reference internal" href="api_metadata.html#pg-dist-rebalance-strategy"><span class="std std-ref">Rebalancer strategy table</span></a>.</p>
<p><strong>name:</strong> identifier for the new strategy</p>
<p><strong>shard_cost_function:</strong> identifies the function used to determine the “cost” of each shard</p>
<p><strong>node_capacity_function:</strong> identifies the function to measure node capacity</p>
<p><strong>shard_allowed_on_node_function:</strong> identifies the function which determines which shards can be placed on which nodes</p>
<p><strong>default_threshold:</strong> a floating point threshold that tunes how precisely the cumulative shard cost should be balanced between nodes</p>
<p><strong>minimum_threshold:</strong> (Optional) a safeguard column that holds the minimum value allowed for the threshold argument of rebalance_table_shards(). Its default value is 0</p>
</div>
<div class="section" id="id129">
<h4>Return Value<a class="headerlink" href="#id129" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
</div>
<div class="section" id="canopy-set-default-rebalance-strategy">
<span id="citus-set-default-rebalance-strategy"></span><h3>canopy_set_default_rebalance_strategy<a class="headerlink" href="#canopy-set-default-rebalance-strategy" title="Permalink to this headline"></a></h3>
<p>Update the <a class="reference internal" href="api_metadata.html#pg-dist-rebalance-strategy"><span class="std std-ref">Rebalancer strategy table</span></a> table, changing the strategy named
by its argument to be the default chosen when rebalancing shards.</p>
<div class="section" id="id130">
<h4>Arguments<a class="headerlink" href="#id130" title="Permalink to this headline"></a></h4>
<p><strong>name:</strong> the name of the strategy in pg_dist_rebalance_strategy</p>
</div>
<div class="section" id="id131">
<h4>Return Value<a class="headerlink" href="#id131" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id132">
<h4>Example<a class="headerlink" href="#id132" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">canopy_set_default_rebalance_strategy</span><span class="p">(</span><span class="s1">&#39;by_disk_size&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-remote-connection-stats">
<span id="citus-remote-connection-stats"></span><h3>canopy_remote_connection_stats<a class="headerlink" href="#canopy-remote-connection-stats" title="Permalink to this headline"></a></h3>
<p>The canopy_remote_connection_stats() function shows the number of active
connections to each remote node.</p>
<div class="section" id="id133">
<h4>Arguments<a class="headerlink" href="#id133" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id134">
<h4>Example<a class="headerlink" href="#id134" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_remote_connection_stats</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span>
    <span class="n">hostname</span>     <span class="o">|</span> <span class="n">port</span> <span class="o">|</span> <span class="n">database_name</span> <span class="o">|</span> <span class="n">connection_count_to_node</span>
<span class="o">----------------+------+---------------+--------------------------</span>
 <span class="n">canopy_worker_1</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="n">postgres</span>      <span class="o">|</span>                        <span class="mi">3</span>
<span class="p">(</span><span class="mi">1</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-drain-node">
<span id="citus-drain-node"></span><h3>canopy_drain_node<a class="headerlink" href="#canopy-drain-node" title="Permalink to this headline"></a></h3>
<p>The canopy_drain_node() function moves shards off the designated node and onto other nodes who have <code class="docutils literal notranslate"><span class="pre">shouldhaveshards</span></code> set to true in <a class="reference internal" href="api_metadata.html#pg-dist-node"><span class="std std-ref">Worker node table</span></a>. This function is designed to be called prior to removing a node from the cluster, i.e. turning the node’s physical server off.</p>
<div class="section" id="id135">
<h4>Arguments<a class="headerlink" href="#id135" title="Permalink to this headline"></a></h4>
<p><strong>nodename:</strong> The hostname name of the node to be drained.</p>
<p><strong>nodeport:</strong> The port number of the node to be drained.</p>
<p><strong>shard_transfer_mode:</strong> (Optional) Specify the method of replication, whether to use LightDB logical replication or a cross-worker COPY command. The possible values are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">auto</span></code>: Require replica identity if logical replication is possible, otherwise use legacy behaviour. This is the default value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">force_logical</span></code>: Use logical replication even if the table doesn’t have a replica identity. Any concurrent update/delete statements to the table will fail during replication.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">block_writes</span></code>: Use COPY (blocking writes) for tables lacking primary key or replica identity.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Canopy supports only the <code class="docutils literal notranslate"><span class="pre">block_writes</span></code> mode, and treats <code class="docutils literal notranslate"><span class="pre">auto</span></code> as <code class="docutils literal notranslate"><span class="pre">block_writes</span></code>.</p>
</div>
</div></blockquote>
<p><strong>rebalance_strategy:</strong> (Optional) the name of a strategy in <a class="reference internal" href="api_metadata.html#pg-dist-rebalance-strategy"><span class="std std-ref">Rebalancer strategy table</span></a>. If this argument is omitted, the function chooses the default strategy, as indicated in the table.</p>
</div>
<div class="section" id="id136">
<h4>Return Value<a class="headerlink" href="#id136" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="id137">
<h4>Example<a class="headerlink" href="#id137" title="Permalink to this headline"></a></h4>
<p>Here are the typical steps to remove a single node (for example ‘10.0.0.1’ on a standard LightDB port):</p>
<ol class="arabic">
<li><p>Drain the node.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">canopy_drain_node</span><span class="p">(</span><span class="s1">&#39;10.0.0.1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">5432</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Wait until the command finishes</p></li>
<li><p>Remove the node</p></li>
</ol>
<p>When draining multiple nodes it’s recommended to use <a class="reference internal" href="#rebalance-table-shards"><span class="std std-ref">rebalance_table_shards</span></a> instead. Doing so allows Canopy to plan ahead and move shards the minimum number of times.</p>
<ol class="arabic">
<li><p>Run this for each node that you want to remove:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">canopy_set_node_property</span><span class="p">(</span><span class="n">node_hostname</span><span class="p">,</span><span class="w"> </span><span class="n">node_port</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shouldhaveshards&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">false</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Drain them all at once with <a class="reference internal" href="#rebalance-table-shards"><span class="std std-ref">rebalance_table_shards</span></a>:</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">rebalance_table_shards</span><span class="p">(</span><span class="n">drain_only</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="k">true</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Wait until the draining rebalance finishes</p></li>
<li><p>Remove the nodes</p></li>
</ol>
</div>
</div>
<div class="section" id="replicate-table-shards">
<h3>replicate_table_shards<a class="headerlink" href="#replicate-table-shards" title="Permalink to this headline"></a></h3>
<p>The replicate_table_shards() function replicates the under-replicated shards of the given table. The function first calculates the list of under-replicated shards and locations from which they can be fetched for replication. The function then copies over those shards and updates the corresponding shard metadata to reflect the copy.</p>
<div class="section" id="id138">
<h4>Arguments<a class="headerlink" href="#id138" title="Permalink to this headline"></a></h4>
<p><strong>table_name:</strong> The name of the table whose shards need to be replicated.</p>
<p><strong>shard_replication_factor:</strong> (Optional) The desired replication factor to achieve for each shard.</p>
<p><strong>max_shard_copies:</strong> (Optional) Maximum number of shards to copy to reach the desired replication factor.</p>
<p><strong>excluded_shard_list:</strong> (Optional) Identifiers of shards which shouldn’t be copied during the replication operation.</p>
</div>
<div class="section" id="id139">
<h4>Return Value<a class="headerlink" href="#id139" title="Permalink to this headline"></a></h4>
<p>N/A</p>
</div>
<div class="section" id="examples">
<h4>Examples<a class="headerlink" href="#examples" title="Permalink to this headline"></a></h4>
<p>The example below will attempt to replicate the shards of the github_events table to shard_replication_factor.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">replicate_table_shards</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>This example will attempt to bring the shards of the github_events table to the desired replication factor with a maximum of 10 shard copies. This means that the rebalancer will copy only a maximum of 10 shards in its attempt to reach the desired replication factor.</p>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">replicate_table_shards</span><span class="p">(</span><span class="s1">&#39;github_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">max_shard_copies</span><span class="p">:</span><span class="o">=</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="canopy-create-restore-point">
<span id="isolate-tenant-to-new-shard"></span><h3>canopy_create_restore_point<a class="headerlink" href="#canopy-create-restore-point" title="Permalink to this headline"></a></h3>
<p>Temporarily blocks writes to the cluster, and creates a named restore point on all nodes. This function is similar to <a class="reference external" href="https://www.hs.net/lightdb/docs/html/functions-admin.html#FUNCTIONS-ADMIN-BACKUP">pg_create_restore_point</a>, but applies to all nodes and makes sure the restore point is consistent across them. This function is well suited to doing point-in-time recovery, and cluster forking.</p>
<div class="section" id="id140">
<h4>Arguments<a class="headerlink" href="#id140" title="Permalink to this headline"></a></h4>
<p><strong>name:</strong> The name of the restore point to create.</p>
</div>
<div class="section" id="id141">
<h4>Return Value<a class="headerlink" href="#id141" title="Permalink to this headline"></a></h4>
<p><strong>coordinator_lsn:</strong> Log sequence number of the restore point in the coordinator node WAL.</p>
</div>
<div class="section" id="id142">
<h4>Examples<a class="headerlink" href="#id142" title="Permalink to this headline"></a></h4>
<div class="highlight-postgresql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">canopy_create_restore_point</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌────────────────────────────┐
│ canopy_create_restore_point│
├────────────────────────────┤
│ 0/1EA2808                  │
└────────────────────────────┘
</pre></div>
</div>
</div>
</div>
</div>
</div>




           </div>
          </div>
        </div>
        <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api.html" class="btn btn-neutral float-left" title="Canopy API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api_metadata.html" class="btn btn-neutral float-right" title="Canopy Tables and Views" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Hundsun Technologies Inc.</p>
  </div>

   

</footer>
      </div>

    </section>
  </div>

  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-32858865-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-32858865-1', {
          'anonymize_ip': false,
      });
    </script>
   

  
  <script type="text/javascript">
    window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
    heap.load("4002524638");
  </script>

  

  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js'></script>

  <script type="text/javascript">
    $(document).ready(function() {
      /* Uses global window.g_cookieConsentId defined in the <head> */

      var consentValue = 'Consented';

      var clickConsent = function () {
        if ($("#consentBox").is(":visible")) {
          if (typeof(window.yett) == 'object' &&
              typeof(window.yett.unblock) == 'function') {
            window.yett.unblock();
          } else {
            console.log("clickConsent: Unable to access window.yett.unblock()");
          }
          // "slideUp" means "hide," it is not a direction of movement
          $("#consentBox").slideUp("linear");
          $.cookie(window.g_cookieConsentId, consentValue, {
            expires: 365,
            path: '/'
          });
          if (typeof(ga) == 'function') {
            ga('set', 'allowAdFeatures', true);
            ga('send', 'event', 'cookie consent', 'accept', window.location.href);
          } else {
            console.log("clickConsent: Unable to access ga()");
          }
        }
      };

      // continuing to interact with the page consents to cookies
      $("a:not(#cookiesLink), button, iframe, input, [data-toggle*='wy-nav-top'], [data-toggle*='rst-current-version']").on(
        "click", clickConsent
      );

      if ($.cookie(window.g_cookieConsentId) != consentValue) {
        // "slideDown" means "show," it's not a direction of movement
        $("#consentBox").slideDown("linear");
      };
    });
  </script>

</body>
</html>